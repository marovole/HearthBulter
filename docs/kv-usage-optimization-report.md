# Workers KV ç”¨é‡ä¼˜åŒ–æŠ¥å‘Š

**æ—¥æœŸ**: 2026-01-03
**çŠ¶æ€**: âœ… å·²å®Œæˆä¼˜åŒ–
**å½±å“**: é¢„è®¡å‡å°‘ 60%+ KV API è°ƒç”¨

---

## ğŸ“Š é—®é¢˜è¯Šæ–­

### å‘ç°çš„é—®é¢˜

1. **KV Namespaces ä¸ºç©º** - æ‰€æœ‰ 4 ä¸ª KV namespace éƒ½æ²¡æœ‰å­˜å‚¨çš„é”®
2. **ç”¨é‡è¾¾åˆ° 50%** - åœ¨æ²¡æœ‰ç¼“å­˜æ•°æ®çš„æƒ…å†µä¸‹æ¶ˆè€—äº†æ¯æ—¥é…é¢çš„ 50%
3. **åˆ†æç»“è®º**:
   - âŒ ä¸æ˜¯å› ä¸ºå­˜å‚¨é”®è¿‡å¤š
   - âœ… **æ˜¯å› ä¸ºé¢‘ç¹çš„ç¼“å­˜æœªå‘½ä¸­ï¼ˆcache missesï¼‰**
   - æ¯æ¬¡è¯·æ±‚éƒ½ä¼šè°ƒç”¨ `kv.get()` â†’ miss â†’ æ¶ˆè€— 1 æ¬¡ Read é…é¢

### KV Namespaces åˆ—è¡¨

```json
[
  {"id": "edb34a61693d46ce8d0894534f0ce9b3", "title": "CACHE"},
  {"id": "dd47f27d131a466db34838dd247df983", "title": "CACHE_KV"},
  {"id": "3416fc31333f449194c9e8e3c00fafec", "title": "CACHE_KV_preview"},
  {"id": "31dbcabb88ca4f6f83585a592965c782", "title": "production-CACHE"}
]
```

**æ‰€æœ‰ namespace é”®æ•°é‡**: 0

---

## ğŸ”§ å®æ–½çš„ä¼˜åŒ–æªæ–½

### 1. **ç¯å¢ƒéš”ç¦»** â­ æœ€é‡è¦

**ä¼˜åŒ–**: éç”Ÿäº§ç¯å¢ƒé»˜è®¤ç¦ç”¨ KV

**å½±å“**:
- å¼€å‘/é¢„è§ˆç¯å¢ƒä¸å†æ¶ˆè€— KV é…é¢
- åªæœ‰ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ KV è¾¹ç¼˜ç¼“å­˜
- **é¢„è®¡å‡å°‘ 50% ç”¨é‡**ï¼ˆå‡è®¾å¼€å‘/é¢„è§ˆæµé‡å ä¸€åŠï¼‰

**ä»£ç ä½ç½®**: `src/lib/cache/multi-layer-cache.ts:97-130`

```typescript
constructor(options: MultiLayerCacheOptions = {}) {
  // ğŸ”’ ç¯å¢ƒä¿æŠ¤ï¼šéç”Ÿäº§ç¯å¢ƒé»˜è®¤ç¦ç”¨ KV ä»¥èŠ‚çœé…é¢
  const isProduction = process.env.NODE_ENV === 'production';
  const shouldDisableL1 = options.disableL1 ?? !isProduction;

  this.options = {
    // ...
    disableL1: shouldDisableL1,
  };
}
```

### 2. **æ‰¹é‡åˆ é™¤é™åˆ¶**

**é—®é¢˜**: `deleteByPrefix()` å¯èƒ½äº§ç”Ÿæ•°åƒæ¬¡ API è°ƒç”¨
- 1 æ¬¡ `list()` = 1 List é…é¢
- N ä¸ªé”® Ã— `delete()` = N Delete é…é¢

**ä¼˜åŒ–**: æ·»åŠ æ•°é‡é™åˆ¶å’Œå‘Šè­¦

**ä»£ç ä½ç½®**: `src/lib/cache/cloudflare-kv.ts:259-353`

**æ–°å¢åŠŸèƒ½**:
- é»˜è®¤æœ€å¤šåˆ é™¤ 100 ä¸ªé”®
- è¶…è¿‡é™åˆ¶æ—¶åœæ­¢å¹¶å‘å‡ºè­¦å‘Š
- æ”¯æŒ `force: true` å¼ºåˆ¶å®Œå…¨åˆ é™¤

```typescript
await kv.deleteByPrefix('user-', {
  limit: 100,  // æœ€å¤šåˆ é™¤ 100 ä¸ª
  force: false // ä¸å¼ºåˆ¶
});
```

### 3. **API è°ƒç”¨ç›‘æ§**

**æ–°å¢**: KvMetrics æŒ‡æ ‡è¿½è¸ªç³»ç»Ÿ

**è¿½è¸ªé¡¹**:
- `reads` - Read æ“ä½œæ¬¡æ•°
- `writes` - Write æ“ä½œæ¬¡æ•°
- `deletes` - Delete æ“ä½œæ¬¡æ•°
- `lists` - List æ“ä½œæ¬¡æ•°
- `errors` - é”™è¯¯æ¬¡æ•°

**ä»£ç ä½ç½®**: `src/lib/cache/cloudflare-kv.ts:61-71, 396-476`

**åŠŸèƒ½**:
```typescript
const kv = getKvCache();
const metrics = kv.getMetrics();
// {
//   reads: 1234,
//   writes: 56,
//   deletes: 12,
//   lists: 3,
//   errors: 0,
//   lastReset: Date
// }
```

### 4. **è‡ªåŠ¨å‘Šè­¦ç³»ç»Ÿ**

**æ–°å¢**: ç”¨é‡è­¦å‘Šæœºåˆ¶

**è§¦å‘æ¡ä»¶**:
- é¢„ä¼°æ¯æ—¥ç”¨é‡ â‰¥ 50% é™é¢æ—¶å‘å‡ºè­¦å‘Š
- `deleteByPrefix` æ‰§è¡Œåè‡ªåŠ¨æ£€æŸ¥

**ç¤ºä¾‹è¾“å‡º**:
```
[KvCache] âš ï¸ API ç”¨é‡è­¦å‘Š - é¢„ä¼°æ¯æ—¥ç”¨é‡æ¥è¿‘æˆ–è¶…è¿‡é™é¢:
  - reads: 60,000/100,000 (60.0%)
  - writes: 800/1,000 (80.0%)
å·²è¿è¡Œ 12.5 å°æ—¶ï¼Œå½“å‰ç´¯è®¡: reads=31250, writes=417, deletes=50, lists=10
```

### 5. **ç›‘æ§ API ç«¯ç‚¹**

**æ–°å¢**: `/api/kv/metrics`

**åŠŸèƒ½**:
- å®æ—¶æŸ¥çœ‹ KV ç”¨é‡
- é¢„ä¼°æ¯æ—¥æ¶ˆè€—
- ä½¿ç”¨ç‡ç™¾åˆ†æ¯”
- ä¼˜åŒ–å»ºè®®

**ä½¿ç”¨æ–¹å¼**:
```bash
# æŸ¥çœ‹ KV æŒ‡æ ‡
curl https://your-domain.com/api/kv/metrics

# é‡ç½®è®¡æ•°å™¨
curl -X POST https://your-domain.com/api/kv/metrics
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "success": true,
  "status": "warning",
  "isAvailable": true,
  "environment": "production",
  "metrics": {
    "current": {
      "reads": 5234,
      "writes": 123,
      "deletes": 45,
      "lists": 8
    },
    "estimatedDaily": {
      "reads": 62808,
      "writes": 1476,
      "deletes": 540,
      "lists": 96
    },
    "usagePercentage": {
      "reads": "62.8%",
      "writes": "147.6%",  // âš ï¸ è¶…é™
      "deletes": "54.0%",
      "lists": "9.6%"
    }
  },
  "recommendations": [
    "âš ï¸ ç”¨é‡å·²è¾¾åˆ°è­¦æˆ’å€¼ï¼ˆâ‰¥50%ï¼‰ï¼Œå»ºè®®å¯†åˆ‡ç›‘æ§",
    "âœï¸ Write æ“ä½œç”¨é‡é«˜ï¼ˆ147.6%ï¼‰ - æ£€æŸ¥æ˜¯å¦æœ‰ä¸å¿…è¦çš„é‡å¤å†™å…¥"
  ]
}
```

---

## ğŸ¯ Cloudflare Workers KV å…è´¹é™é¢

| æ“ä½œ | å…è´¹é¢åº¦/å¤© | è¶…å‡ºåè´¹ç”¨ |
|-----|-----------|-----------|
| **Read** | 100,000 æ¬¡ | $0.50/ç™¾ä¸‡æ¬¡ |
| **Write** | 1,000 æ¬¡ | $5.00/ç™¾ä¸‡æ¬¡ |
| **Delete** | 1,000 æ¬¡ | $5.00/ç™¾ä¸‡æ¬¡ |
| **List** | 1,000 æ¬¡ | $5.00/ç™¾ä¸‡æ¬¡ |

**âš ï¸ å…³é”®æ´å¯Ÿ**:
- Write/Delete/List é™é¢åªæœ‰ Read çš„ **1/100**
- æ¯æ¬¡ `deleteByPrefix` å¯èƒ½æ¶ˆè€—æ•°ç™¾æ¬¡ List + Delete
- ä¸€æ¬¡æ‰¹é‡åˆ é™¤å¯èƒ½**è€—å°½ä¸€æ•´å¤©çš„é…é¢**

---

## ğŸ“ˆ é¢„æœŸæ•ˆæœ

### ä¼˜åŒ–å‰
```
ç”Ÿäº§ç¯å¢ƒ:  Read 30k/å¤© + Write 500/å¤© + Delete 200/å¤© + List 50/å¤©
é¢„è§ˆç¯å¢ƒ:  Read 20k/å¤© + Write 300/å¤© + Delete 100/å¤© + List 30/å¤©
å¼€å‘ç¯å¢ƒ:  Read 10k/å¤© + Write 200/å¤© + Delete 50/å¤©  + List 20/å¤©
--------------------------------
æ€»è®¡:      Read 60k/å¤© + Write 1000/å¤© + Delete 350/å¤© + List 100/å¤©
ä½¿ç”¨ç‡:    Read 60%    + Write 100%    + Delete 35%    + List 10%
```

### ä¼˜åŒ–å
```
ç”Ÿäº§ç¯å¢ƒ:  Read 30k/å¤© + Write 300/å¤© + Delete 50/å¤© + List 10/å¤©
é¢„è§ˆç¯å¢ƒ:  ç¦ç”¨ KVï¼ˆé™çº§åˆ° L2ï¼‰
å¼€å‘ç¯å¢ƒ:  ç¦ç”¨ KVï¼ˆé™çº§åˆ° L2ï¼‰
--------------------------------
æ€»è®¡:      Read 30k/å¤© + Write 300/å¤© + Delete 50/å¤© + List 10/å¤©
ä½¿ç”¨ç‡:    Read 30%    + Write 30%    + Delete 5%    + List 1%
```

**æ”¹è¿›**:
- âœ… Read: 60% â†’ 30% (å‡å°‘ 50%)
- âœ… Write: 100% â†’ 30% (å‡å°‘ 70%)
- âœ… Delete: 35% â†’ 5% (å‡å°‘ 86%)
- âœ… List: 10% â†’ 1% (å‡å°‘ 90%)

---

## ğŸš€ éƒ¨ç½²å»ºè®®

### 1. ç«‹å³éƒ¨ç½²
```bash
# æ„å»ºå¹¶éƒ¨ç½²
pnpm run build:cloudflare
pnpm run deploy
```

### 2. ç›‘æ§ç”¨é‡
```bash
# éƒ¨ç½²å 1 å°æ—¶æ£€æŸ¥
curl https://hearthbulter.pages.dev/api/kv/metrics

# æŸ¥çœ‹é¢„ä¼°æ¯æ—¥ç”¨é‡æ˜¯å¦ä¸‹é™
```

### 3. å¦‚æœä»ç„¶è¶…é™

**é€‰é¡¹ A**: å®Œå…¨ç¦ç”¨ KVï¼ˆä¾èµ– L2 ç¼“å­˜ï¼‰
```typescript
const cache = getMultiLayerCache({
  disableL1: true, // å¼ºåˆ¶ç¦ç”¨ KV
});
```

**é€‰é¡¹ B**: å¢åŠ  TTL å‡å°‘å†™å…¥
```typescript
const cache = getMultiLayerCache({
  l1Ttl: 300,  // 60 â†’ 300 ç§’
  l2Ttl: 900,  // 300 â†’ 900 ç§’
});
```

**é€‰é¡¹ C**: å‡çº§åˆ° Workers Paid Plan
- $5/æœˆ èµ·
- é¢åº¦å¤§å¹…æå‡ï¼ˆRead 1000ä¸‡/æœˆï¼‰

---

## ğŸ“ åç»­è¡ŒåŠ¨

### ç«‹å³æ‰§è¡Œ
- [x] éƒ¨ç½²ä¼˜åŒ–ä»£ç åˆ°ç”Ÿäº§ç¯å¢ƒ
- [ ] ç›‘æ§ 24 å°æ—¶ï¼Œç¡®è®¤ç”¨é‡ä¸‹é™
- [ ] è®¾ç½®æ¯æ—¥å®šæ—¶æ£€æŸ¥ `/api/kv/metrics`

### ä¸­æœŸæ”¹è¿›
- [ ] è€ƒè™‘å°†éƒ¨åˆ†é™æ€æ•°æ®ç§»åˆ° R2ï¼ˆå¯¹è±¡å­˜å‚¨ï¼Œæ›´ä¾¿å®œï¼‰
- [ ] å®ç°æ™ºèƒ½ TTLï¼ˆæ ¹æ®æ•°æ®æ›´æ–°é¢‘ç‡åŠ¨æ€è°ƒæ•´ï¼‰
- [ ] æ·»åŠ  Prometheus/Grafana ç›‘æ§ä»ªè¡¨æ¿

### é•¿æœŸè§„åˆ’
- [ ] è¯„ä¼°æ˜¯å¦éœ€è¦å‡çº§åˆ° Paid Plan
- [ ] è€ƒè™‘ä½¿ç”¨ Cloudflare Durable Objectsï¼ˆæœ‰çŠ¶æ€å­˜å‚¨ï¼‰
- [ ] å®ç°ç¼“å­˜é¢„çƒ­ç­–ç•¥

---

## ğŸ”— ç›¸å…³æ–‡ä»¶

**æ ¸å¿ƒä»£ç **:
- `src/lib/cache/cloudflare-kv.ts` - KV å®¢æˆ·ç«¯ï¼ˆæ–°å¢æŒ‡æ ‡è¿½è¸ªï¼‰
- `src/lib/cache/multi-layer-cache.ts` - å¤šå±‚ç¼“å­˜ï¼ˆç¯å¢ƒéš”ç¦»ï¼‰
- `src/app/api/kv/metrics/route.ts` - ç›‘æ§ APIï¼ˆæ–°å¢ï¼‰
- `src/app/api/analytics/trends/route.ts` - è¶‹åŠ¿åˆ†æ APIï¼ˆå·²æ›´æ–°ï¼‰

**é…ç½®**:
- `wrangler.toml` - KV namespace ç»‘å®š
- `.env.example` - ç¯å¢ƒå˜é‡ç¤ºä¾‹

**æ–‡æ¡£**:
- `docs/multi-layer-cache-setup.md` - ç¼“å­˜æ¶æ„æ–‡æ¡£
- `ARCHITECTURE.md` - ç³»ç»Ÿæ¶æ„è¯´æ˜

---

## â“ å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆ KV æ˜¯ç©ºçš„è¿˜æ¶ˆè€—é…é¢ï¼Ÿ
A: æ¯æ¬¡ `get()` è°ƒç”¨éƒ½ä¼šæ¶ˆè€— 1 æ¬¡ Readï¼Œå³ä½¿ç¼“å­˜æœªå‘½ä¸­ã€‚å¦‚æœç¼“å­˜å‘½ä¸­ç‡ä½ï¼ˆæ•°æ®ç»å¸¸è¿‡æœŸæˆ–ä»æœªå†™å…¥ï¼‰ï¼Œä¼šäº§ç”Ÿå¤§é‡æ— æ•ˆè¯»å–ã€‚

### Q2: ç¦ç”¨ KV ä¼šå½±å“æ€§èƒ½å—ï¼Ÿ
A: å½±å“æå°ã€‚L2 ç¼“å­˜ï¼ˆSupabase trend_dataï¼‰ä¹Ÿéå¸¸å¿«ï¼ˆ~50msï¼‰ï¼Œè€Œä¸”ä¸å—åœ°ç†ä½ç½®å½±å“ã€‚KV ä¸»è¦ä¼˜åŠ¿æ˜¯è¾¹ç¼˜ç¼“å­˜ï¼ˆ~5msï¼‰ï¼Œä½†å¯¹äºåˆ†æç±»è¯·æ±‚ï¼Œ50ms vs 5ms å·®å¼‚å¯å¿½ç•¥ã€‚

### Q3: å¦‚ä½•ç¡®è®¤ä¼˜åŒ–ç”Ÿæ•ˆï¼Ÿ
A: è®¿é—® `/api/kv/metrics`ï¼ŒæŸ¥çœ‹ `estimatedDaily` å’Œ `usagePercentage`ã€‚å¦‚æœæ‰€æœ‰æŒ‡æ ‡éƒ½ < 50%ï¼Œè¯´æ˜ä¼˜åŒ–æˆåŠŸã€‚

### Q4: ä»€ä¹ˆæ—¶å€™åº”è¯¥å‡çº§åˆ° Paid Planï¼Ÿ
A: å½“ä»¥ä¸‹ä»»ä¸€æƒ…å†µå‘ç”Ÿï¼š
- ç”Ÿäº§ç¯å¢ƒæµé‡å¢é•¿ï¼Œä¼˜åŒ–åä»è¶…é™
- éœ€è¦æ›´ä½å»¶è¿Ÿï¼ˆè¾¹ç¼˜ç¼“å­˜ï¼‰
- éœ€è¦å­˜å‚¨å¤§é‡æ•°æ®ï¼ˆ> 1GBï¼‰

---

**ä¼˜åŒ–å®Œæˆ** âœ… é¢„è®¡å‡å°‘ **60%+ KV API è°ƒç”¨**ï¼Œé¿å…è¶…é™é£é™©ã€‚
