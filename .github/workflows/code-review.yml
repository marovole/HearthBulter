name: Code Review

on:
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'src/**/*.{ts,tsx,js,jsx}'
      - 'app/**/*.{ts,tsx,js,jsx}'
      - 'pages/**/*.{ts,tsx,js,jsx}'
  push:
    branches: [ main ]
    paths:
      - 'src/**/*.{ts,tsx,js,jsx}'
      - 'app/**/*.{ts,tsx,js,jsx}'
      - 'pages/**/*.{ts,tsx,js,jsx}'

# å®šä¹‰çŽ¯å¢ƒå˜é‡
env:
  NODE_VERSION: '20'
  PNPM_VERSION: '10'

jobs:
  code-review:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ðŸ“¦ å®‰è£… pnpm
      uses: pnpm/action-setup@v4
      with:
        version: ${{ env.PNPM_VERSION }}

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'pnpm'

    - name: Install dependencies
      run: pnpm install --frozen-lockfile

    - name: ðŸ—ï¸ ç”Ÿæˆ Prisma Client
      run: pnpm db:generate

    - name: Type checking
      run: pnpm type-check

    - name: Lint code
      continue-on-error: true
      run: pnpm lint -- --max-warnings=9999

    - name: Run tests
      continue-on-error: true
      run: pnpm test
      env:
        # æµ‹è¯•çŽ¯å¢ƒå˜é‡ï¼ˆä½¿ç”¨ mock å€¼ï¼‰
        DATABASE_URL: "postgresql://test:test@localhost:5432/test"
        NEXT_PUBLIC_SUPABASE_URL: "https://test.supabase.co"
        SUPABASE_SERVICE_KEY: "test-service-key"
        NEXTAUTH_SECRET: "test-secret-key-for-ci-testing-only"
        NEXTAUTH_URL: "http://localhost:3000"

    - name: Build project
      run: pnpm build
      env:
        # æž„å»ºçŽ¯å¢ƒå˜é‡ï¼ˆä½¿ç”¨ mock å€¼ï¼‰
        DATABASE_URL: "postgresql://test:test@localhost:5432/test"
        NEXT_PUBLIC_SUPABASE_URL: "https://test.supabase.co"
        SUPABASE_SERVICE_KEY: "test-service-key"
        NEXTAUTH_SECRET: "test-secret-key-for-ci-building-only"
        NEXTAUTH_URL: "http://localhost:3000"
        SKIP_ENV_VALIDATION: "true"

    - name: Code review analysis
      run: |
        # èŽ·å–å˜æ›´çš„æ–‡ä»¶
        if [ "${{ github.event_name }}" = "pull_request" ]; then
          CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }} | grep -E '\.(ts|tsx|js|jsx)$' | grep -v -E '(node_modules|dist|build|\.next|coverage|\.test\.|\.spec\.)' || true)
        else
          CHANGED_FILES=$(git diff --name-only HEAD~1 | grep -E '\.(ts|tsx|js|jsx)$' | grep -v -E '(node_modules|dist|build|\.next|coverage|\.test\.|\.spec\.)' || true)
        fi

        if [ -z "$CHANGED_FILES" ]; then
          echo "No code files changed, skipping code review"
          exit 0
        fi

        echo "Files to review:"
        echo "$CHANGED_FILES"
        echo ""

        # åˆ›å»ºå®¡æŸ¥æŠ¥å‘Š
        echo "## Code Review Report" > code-review-report.md
        echo "" >> code-review-report.md
        echo "### Changed Files" >> code-review-report.md
        echo "$CHANGED_FILES" | sed 's/^/- /' >> code-review-report.md
        echo "" >> code-review-report.md

        # åŸºæœ¬ç»Ÿè®¡
        TOTAL_FILES=$(echo "$CHANGED_FILES" | wc -l)
        TS_FILES=$(echo "$CHANGED_FILES" | grep -c '\.ts$' || true)
        TSX_FILES=$(echo "$CHANGED_FILES" | grep -c '\.tsx$' || true)
        JS_FILES=$(echo "$CHANGED_FILES" | grep -c '\.js$' || true)

        echo "### Statistics" >> code-review-report.md
        echo "- Total files: $TOTAL_FILES" >> code-review-report.md
        echo "- TypeScript: $TS_FILES" >> code-review-report.md
        echo "- React/TypeScript: $TSX_FILES" >> code-review-report.md
        echo "- JavaScript: $JS_FILES" >> code-review-report.md
        echo "" >> code-review-report.md

        # æ£€æŸ¥æ½œåœ¨é—®é¢˜
        ISSUES_FOUND=0

        echo "### Potential Issues" >> code-review-report.md

        # æ£€æŸ¥anyç±»åž‹ä½¿ç”¨
        ANY_COUNT=$(grep -r ": any\|<any>" src/ --include="*.ts" --include="*.tsx" 2>/dev/null | wc -l || true)
        if [ "$ANY_COUNT" -gt 0 ]; then
          echo "âš ï¸ Found $ANY_COUNT instances of 'any' type usage" >> code-review-report.md
          ISSUES_FOUND=$((ISSUES_FOUND + 1))
        fi

        # æ£€æŸ¥console.log
        CONSOLE_COUNT=$(grep -r "console\.log" src/ --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" 2>/dev/null | wc -l || true)
        if [ "$CONSOLE_COUNT" -gt 0 ]; then
          echo "ðŸ’¡ Found $CONSOLE_COUNT console.log statements" >> code-review-report.md
          ISSUES_FOUND=$((ISSUES_FOUND + 1))
        fi

        # æ£€æŸ¥é•¿å‡½æ•°ï¼ˆç®€åŒ–æ£€æŸ¥ï¼‰
        LONG_FILES=$(find src/ -name "*.ts" -o -name "*.tsx" -o -name "*.js" -o -name "*.jsx" | xargs wc -l | awk '$1 > 200 {print $2}' | wc -l || true)
        if [ "$LONG_FILES" -gt 0 ]; then
          echo "ðŸ“ Found $LONG_FILES potentially long files (>200 lines)" >> code-review-report.md
          ISSUES_FOUND=$((ISSUES_FOUND + 1))
        fi

        if [ "$ISSUES_FOUND" -eq 0 ]; then
          echo "âœ… No obvious issues found" >> code-review-report.md
        fi

        echo "" >> code-review-report.md
        echo "### Recommendations" >> code-review-report.md
        echo "1. Ensure all TypeScript files have proper type annotations" >> code-review-report.md
        echo "2. Remove console.log statements before production" >> code-review-report.md
        echo "3. Consider breaking down large files into smaller modules" >> code-review-report.md
        echo "4. Run 'pnpm lint' and 'pnpm type-check' locally before committing" >> code-review-report.md

    - name: Upload review report
      uses: actions/upload-artifact@v4
      with:
        name: code-review-report
        path: code-review-report.md

    - name: Comment PR with review results
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const reportPath = 'code-review-report.md';

          if (fs.existsSync(reportPath)) {
            const report = fs.readFileSync(reportPath, 'utf8');

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ðŸ¤– Automated Code Review Results\n\n${report}\n\n---\n*This comment was generated automatically by the code review workflow.*`
            });
          }

  quality-gate:
    runs-on: ubuntu-latest
    needs: code-review

    steps:
    - name: Quality gate check
      run: |
        echo "Quality checks completed successfully"
        echo "All automated checks have passed"
