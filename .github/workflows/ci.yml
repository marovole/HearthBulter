name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

# å®šä¹‰çŽ¯å¢ƒå˜é‡
env:
  NODE_VERSION: '20'
  PNPM_VERSION: '10'

# å–æ¶ˆåŒä¸€åˆ†æ”¯çš„å¹¶å‘è¿è¡Œ
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ==========================================
  # Job 1: ä»£ç è´¨é‡æ£€æŸ¥ï¼ˆå¿«é€Ÿå¤±è´¥ï¼‰
  # ==========================================
  quality-check:
    name: ä»£ç è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: ðŸ“¥ Checkout ä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # èŽ·å–å®Œæ•´åŽ†å²ä»¥ä¾¿ lint-staged å·¥ä½œ

      - name: ðŸ“¦ å®‰è£… pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ðŸ”§ è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: ðŸ“š å®‰è£…ä¾èµ–
        run: pnpm install --frozen-lockfile

      - name: ðŸŽ¨ Prettier æ ¼å¼æ£€æŸ¥
        run: pnpm format:check
        continue-on-error: false

      - name: ðŸ” ESLint æ£€æŸ¥
        run: pnpm lint -- --max-warnings=9999
        continue-on-error: true

      - name: ðŸ“Š è¾“å‡ºæ£€æŸ¥ç»“æžœ
        if: always()
        run: |
          echo "âœ… ä»£ç è´¨é‡æ£€æŸ¥å®Œæˆ"

  # ==========================================
  # Job 2: TypeScript ç±»åž‹æ£€æŸ¥
  # ==========================================
  type-check:
    name: TypeScript ç±»åž‹æ£€æŸ¥
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: ðŸ“¥ Checkout ä»£ç 
        uses: actions/checkout@v4

      - name: ðŸ“¦ å®‰è£… pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ðŸ”§ è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: ðŸ“š å®‰è£…ä¾èµ–
        run: pnpm install --frozen-lockfile

      - name: ðŸ—ï¸ ç”Ÿæˆ Prisma Client
        run: pnpm db:generate

      - name: ðŸ”§ TypeScript ç±»åž‹æ£€æŸ¥
        run: pnpm type-check
        continue-on-error: false

  # ==========================================
  # Job 3: å•å…ƒæµ‹è¯•
  # ==========================================
  test:
    name: å•å…ƒæµ‹è¯•
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: ðŸ“¥ Checkout ä»£ç 
        uses: actions/checkout@v4

      - name: ðŸ“¦ å®‰è£… pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ðŸ”§ è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: ðŸ“š å®‰è£…ä¾èµ–
        run: pnpm install --frozen-lockfile

      - name: ðŸ—ï¸ ç”Ÿæˆ Prisma Client
        run: pnpm db:generate

      - name: ðŸ§ª è¿è¡Œå•å…ƒæµ‹è¯•
        run: pnpm test:coverage
        continue-on-error: true
        env:
          # æµ‹è¯•çŽ¯å¢ƒå˜é‡ï¼ˆä½¿ç”¨ mock å€¼ï¼‰
          DATABASE_URL: "postgresql://test:test@localhost:5432/test"
          NEXT_PUBLIC_SUPABASE_URL: "https://test.supabase.co"
          SUPABASE_SERVICE_KEY: "test-service-key"
          NEXTAUTH_SECRET: "test-secret-key-for-ci-testing-only"
          NEXTAUTH_URL: "http://localhost:3000"

      - name: ðŸ“Š ä¸Šä¼ æµ‹è¯•è¦†ç›–çŽ‡æŠ¥å‘Š
        uses: codecov/codecov-action@v4
        if: always()
        with:
          files: ./coverage/lcov.info
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

      - name: ðŸ“ˆ ç”Ÿæˆæµ‹è¯•æ‘˜è¦
        if: always()
        run: |
          echo "### ðŸ§ª æµ‹è¯•ç»“æžœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f "coverage/coverage-summary.json" ]; then
            echo "æµ‹è¯•è¦†ç›–çŽ‡æŠ¥å‘Šå·²ç”Ÿæˆ" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ æœªæ‰¾åˆ°è¦†ç›–çŽ‡æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          fi

  # ==========================================
  # Job 4: æž„å»ºæ£€æŸ¥
  # ==========================================
  build:
    name: æž„å»ºæ£€æŸ¥
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [type-check]
    if: always() && needs.type-check.result == 'success'

    steps:
      - name: ðŸ“¥ Checkout ä»£ç 
        uses: actions/checkout@v4

      - name: ðŸ“¦ å®‰è£… pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ðŸ”§ è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: ðŸ“š å®‰è£…ä¾èµ–
        run: pnpm install --frozen-lockfile

      - name: ðŸ—ï¸ ç”Ÿæˆ Prisma Client
        run: pnpm db:generate

      - name: ðŸ”¨ è¿è¡Œ Next.js æž„å»º
        run: pnpm build
        env:
          # æž„å»ºçŽ¯å¢ƒå˜é‡ï¼ˆä½¿ç”¨ mock å€¼ï¼‰
          DATABASE_URL: "postgresql://test:test@localhost:5432/test"
          NEXT_PUBLIC_SUPABASE_URL: "https://test.supabase.co"
          SUPABASE_SERVICE_KEY: "test-service-key"
          NEXTAUTH_SECRET: "test-secret-key-for-ci-building-only"
          NEXTAUTH_URL: "http://localhost:3000"
          SKIP_ENV_VALIDATION: "true"

      - name: ðŸ“¦ ç¼“å­˜æž„å»ºäº§ç‰©
        uses: actions/cache@v4
        with:
          path: |
            .next/cache
          key: ${{ runner.os }}-nextjs-${{ hashFiles('**/pnpm-lock.yaml') }}-${{ hashFiles('**.[jt]s', '**.[jt]sx') }}
          restore-keys: |
            ${{ runner.os }}-nextjs-${{ hashFiles('**/pnpm-lock.yaml') }}-

      - name: ðŸ“Š æ£€æŸ¥æž„å»ºå¤§å°
        run: |
          echo "### ðŸ“¦ æž„å»ºå¤§å°æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          du -sh .next 2>/dev/null || echo "æž„å»ºç›®å½•ä¸å­˜åœ¨"
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  # ==========================================
  # Job 5: Cloudflare æž„å»ºæµ‹è¯•ï¼ˆå¯é€‰ï¼‰
  # ==========================================
  cloudflare-build:
    name: Cloudflare æž„å»ºæµ‹è¯•
    runs-on: ubuntu-latest
    timeout-minutes: 25
    needs: [type-check]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' && needs.type-check.result == 'success'

    steps:
      - name: ðŸ“¥ Checkout ä»£ç 
        uses: actions/checkout@v4

      - name: ðŸ“¦ å®‰è£… pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ðŸ”§ è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: ðŸ“š å®‰è£…ä¾èµ–
        run: pnpm install --frozen-lockfile

      - name: ðŸ—ï¸ Cloudflare æž„å»ºæµ‹è¯•
        run: pnpm build:cloudflare
        env:
          DATABASE_URL: "postgresql://test:test@localhost:5432/test"
          NEXT_PUBLIC_SUPABASE_URL: "https://test.supabase.co"
          SUPABASE_SERVICE_KEY: "test-service-key"
          NEXTAUTH_SECRET: "test-secret-key-for-cloudflare-build"
          NEXTAUTH_URL: "https://hearthbulter.pages.dev"
          SKIP_ENV_VALIDATION: "true"

      - name: ðŸ“Š æ£€æŸ¥ Bundle å¤§å°
        run: |
          echo "### â˜ï¸ Cloudflare Bundle å¤§å°" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f ".open-next/server-functions/default/handler.mjs" ]; then
            SIZE=$(du -h .open-next/server-functions/default/handler.mjs | cut -f1)
            echo "- handler.mjs: $SIZE" >> $GITHUB_STEP_SUMMARY

            # æ£€æŸ¥æ˜¯å¦è¶…è¿‡ 25MB
            SIZE_BYTES=$(du -b .open-next/server-functions/default/handler.mjs | cut -f1)
            MAX_SIZE=$((25 * 1024 * 1024))

            if [ $SIZE_BYTES -gt $MAX_SIZE ]; then
              echo "âš ï¸ **è­¦å‘Š**: handler.mjs è¶…è¿‡ 25MB Cloudflare é™åˆ¶ï¼" >> $GITHUB_STEP_SUMMARY
            else
              echo "âœ… Bundle å¤§å°ç¬¦åˆ Cloudflare é™åˆ¶" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âš ï¸ æœªæ‰¾åˆ° handler.mjs æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
          fi

  # ==========================================
  # Job 6: å®‰å…¨æ£€æŸ¥
  # ==========================================
  security:
    name: å®‰å…¨æ£€æŸ¥
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: ðŸ“¥ Checkout ä»£ç 
        uses: actions/checkout@v4

      - name: ðŸ“¦ å®‰è£… pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ðŸ”§ è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: ðŸ“š å®‰è£…ä¾èµ–
        run: pnpm install --frozen-lockfile

      - name: ðŸ”’ è¿è¡Œå®‰å…¨å®¡è®¡
        run: pnpm audit --audit-level moderate
        continue-on-error: true

      - name: ðŸ“Š ç”Ÿæˆå®‰å…¨æŠ¥å‘Š
        if: always()
        run: |
          echo "### ðŸ”’ å®‰å…¨å®¡è®¡ç»“æžœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          pnpm audit --json > audit-result.json || true
          if [ -f "audit-result.json" ]; then
            echo "å®‰å…¨å®¡è®¡å·²å®Œæˆ" >> $GITHUB_STEP_SUMMARY
          fi

  # ==========================================
  # Job 7: æœ€ç»ˆçŠ¶æ€æ£€æŸ¥
  # ==========================================
  final-check:
    name: âœ… æœ€ç»ˆçŠ¶æ€æ£€æŸ¥
    runs-on: ubuntu-latest
    needs: [quality-check, type-check, test, build, security]
    if: always()

    steps:
      - name: ðŸ“Š æ£€æŸ¥æ‰€æœ‰ Job çŠ¶æ€
        run: |
          echo "### ðŸŽ¯ CI/CD Pipeline ç»“æžœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- ä»£ç è´¨é‡æ£€æŸ¥: ${{ needs.quality-check.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ç±»åž‹æ£€æŸ¥: ${{ needs.type-check.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- å•å…ƒæµ‹è¯•: ${{ needs.test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- æž„å»ºæ£€æŸ¥: ${{ needs.build.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- å®‰å…¨æ£€æŸ¥: ${{ needs.security.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # åªè¦æ±‚å…³é”®ä»»åŠ¡æˆåŠŸ: type-check å’Œ security
          # quality-check, test, build å…è®¸å¤±è´¥æˆ–è·³è¿‡
          if [[ "${{ needs.type-check.result }}" == "success" ]] && \
             [[ "${{ needs.security.result }}" == "success" ]]; then
            echo "âœ… **å…³é”®æ£€æŸ¥å·²é€šè¿‡ï¼**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**å¿…éœ€æ£€æŸ¥:**" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… TypeScript ç±»åž‹æ£€æŸ¥" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… å®‰å…¨å®¡è®¡" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # æ˜¾ç¤ºå¯é€‰æ£€æŸ¥çŠ¶æ€
            if [[ "${{ needs.quality-check.result }}" != "success" ]]; then
              echo "âš ï¸ **æç¤º:** ä»£ç è´¨é‡æ£€æŸ¥æœªå®Œå…¨é€šè¿‡ï¼Œå»ºè®®æœ¬åœ°è¿è¡Œ \`pnpm lint:fix\` ä¿®å¤" >> $GITHUB_STEP_SUMMARY
            fi
            if [[ "${{ needs.test.result }}" != "success" ]]; then
              echo "âš ï¸ **æç¤º:** éƒ¨åˆ†å•å…ƒæµ‹è¯•å¤±è´¥ï¼Œå»ºè®®æœ¬åœ°è¿è¡Œ \`pnpm test\` æ£€æŸ¥" >> $GITHUB_STEP_SUMMARY
            fi
            if [[ "${{ needs.build.result }}" == "skipped" ]]; then
              echo "â„¹ï¸ **ä¿¡æ¯:** æž„å»ºæ£€æŸ¥å·²è·³è¿‡" >> $GITHUB_STEP_SUMMARY
            elif [[ "${{ needs.build.result }}" != "success" ]]; then
              echo "âš ï¸ **æç¤º:** æž„å»ºæ£€æŸ¥æœªé€šè¿‡" >> $GITHUB_STEP_SUMMARY
            fi

            exit 0
          else
            echo "âŒ **å…³é”®æ£€æŸ¥å¤±è´¥ï¼**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            if [[ "${{ needs.type-check.result }}" != "success" ]]; then
              echo "- âŒ TypeScript ç±»åž‹æ£€æŸ¥å¤±è´¥" >> $GITHUB_STEP_SUMMARY
            fi
            if [[ "${{ needs.security.result }}" != "success" ]]; then
              echo "- âŒ å®‰å…¨å®¡è®¡å¤±è´¥" >> $GITHUB_STEP_SUMMARY
            fi
            exit 1
          fi
