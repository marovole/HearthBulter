#!/usr/bin/env sh

echo "🔍 运行 pre-commit 检查..."
echo ""

# ===================================
# 1. 运行 lint-staged (ESLint + Prettier)
# ===================================
echo "📝 1/4 检查代码格式和风格..."
npx lint-staged
if [ $? -ne 0 ]; then
  echo "❌ ESLint/Prettier 检查失败！"
  echo "💡 提示: 运行 'pnpm lint:fix' 自动修复大部分问题"
  exit 1
fi
echo "✅ 代码格式检查通过"
echo ""

# ===================================
# 2. 运行 TypeScript 类型检查（仅检查 staged 文件）
# ===================================
echo "🔧 2/4 检查 TypeScript 类型..."

# 获取所有 staged 的 TypeScript 文件
STAGED_TS_FILES=$(git diff --cached --name-only --diff-filter=ACMR | grep -E '\.(ts|tsx)$' || true)

if [ -n "$STAGED_TS_FILES" ]; then
  # 只检查 staged 的文件
  echo "  检查 $(echo "$STAGED_TS_FILES" | wc -l | tr -d ' ') 个 TypeScript 文件..."

  # 运行类型检查（快速模式 - 不发出文件）
  npx tsc --noEmit --pretty false $STAGED_TS_FILES 2>&1 | head -20

  if [ $? -ne 0 ]; then
    echo "❌ TypeScript 类型检查失败！"
    echo "💡 提示: 运行 'pnpm type-check' 查看完整错误"
    echo "💡 如果是 P1 级别错误，可以暂时添加 // @ts-expect-error 注释"
    exit 1
  fi
  echo "✅ TypeScript 类型检查通过"
else
  echo "  ℹ️  没有 TypeScript 文件需要检查"
fi
echo ""

# ===================================
# 3. 运行代码审查（可选 - 可以注释掉加快速度）
# ===================================
echo "🔍 3/4 运行代码审查..."
if [ -f "scripts/pre-commit-code-review.js" ]; then
  node scripts/pre-commit-code-review.js
  if [ $? -ne 0 ]; then
    echo "⚠️  代码审查发现一些问题，但不阻止提交"
    echo "💡 提示: 请考虑修复这些问题"
  else
    echo "✅ 代码审查通过"
  fi
else
  echo "  ℹ️  跳过代码审查（脚本不存在）"
fi
echo ""

# ===================================
# 4. 检查敏感信息（防止泄露密钥）
# ===================================
echo "🔐 4/4 检查敏感信息..."

# 检查是否有潜在的密钥或敏感信息
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACMR)

# 检查常见的敏感模式
SENSITIVE_PATTERNS=(
  "SUPABASE_SERVICE_KEY=[a-zA-Z0-9]"
  "NEXTAUTH_SECRET=[a-zA-Z0-9]"
  "API_KEY=[a-zA-Z0-9]"
  "api[_-]?key.*=.*['\"][a-zA-Z0-9]{20,}"
  "password.*=.*['\"][^'\"]{8,}"
  "sk-[a-zA-Z0-9]{20,}"  # OpenAI API key pattern
)

FOUND_SENSITIVE=false
for file in $STAGED_FILES; do
  if [ -f "$file" ]; then
    for pattern in "${SENSITIVE_PATTERNS[@]}"; do
      if grep -qE "$pattern" "$file" 2>/dev/null; then
        echo "⚠️  检测到潜在的敏感信息: $file"
        echo "   模式: $pattern"
        FOUND_SENSITIVE=true
      fi
    done
  fi
done

if [ "$FOUND_SENSITIVE" = true ]; then
  echo ""
  echo "❌ 检测到可能的敏感信息！"
  echo "💡 请确认这些文件不包含真实的密钥或密码"
  echo "💡 使用环境变量或 .env 文件存储敏感信息"
  echo ""
  read -p "确认这些文件安全吗？继续提交？(y/N) " -n 1 -r
  echo
  if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "❌ 提交已取消"
    exit 1
  fi
fi

echo "✅ 敏感信息检查通过"
echo ""

# ===================================
# 全部检查通过
# ===================================
echo "✅ 所有 pre-commit 检查通过！"
echo ""
