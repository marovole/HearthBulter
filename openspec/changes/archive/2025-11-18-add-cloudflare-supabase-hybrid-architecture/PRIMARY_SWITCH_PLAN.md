# ä¸»åº“åˆ‡æ¢è®¡åˆ’ - Prisma â†’ Supabase

**è®¡åˆ’æ—¥æœŸ**: 2025-11-17
**æ‰§è¡Œäºº**: Claude + ç”¨æˆ·
**é¢„è®¡æ—¶é—´**: 30-60 åˆ†é’Ÿ
**é£é™©ç­‰çº§**: ğŸŸ¡ ä¸­ç­‰ï¼ˆæœ‰å›æ»šæ–¹æ¡ˆï¼‰

---

## ğŸ“Š å½“å‰çŠ¶æ€

### Feature Flags é…ç½®
```
- enableDualWrite: âœ… å¼€å¯
- enableSupabasePrimary: âšª Prisma ä¸ºä¸»
- æœ€åæ›´æ–°: 2025-11-16T03:05:05.801+00:00
```

### è¿ç§»è¿›åº¦
- âœ… Phase 0: åŸºç¡€è®¾æ–½ (100%)
- âœ… Batch 1: ä½é£é™© CRUD (100%) - 6 ä¸ªç«¯ç‚¹
- âœ… Batch 2: é€šçŸ¥ç³»ç»Ÿ (100%) - 5 ä¸ªç«¯ç‚¹
- âœ… Batch 3: å®¶åº­/è´­ç‰©/åº“å­˜ (100%) - 10 ä¸ªç«¯ç‚¹
- âœ… **Batch 4: è´¢åŠ¡/é€šçŸ¥å†™è·¯å¾„ (100%) - 7 ä¸ªç«¯ç‚¹**
- âœ… Batch 5: AI/Analytics (å¤§éƒ¨åˆ†å®Œæˆ) - 7 ä¸ªç«¯ç‚¹

**æ€»è®¡**: ~35 ä¸ª API ç«¯ç‚¹å·²å®Œæˆè¿ç§»å’ŒéªŒè¯

---

## ğŸ¯ åˆ‡æ¢ç›®æ ‡

å°†ä¸»åº“ä» **Prisma** åˆ‡æ¢åˆ° **Supabase**ï¼ŒåŒæ—¶ä¿æŒåŒå†™éªŒè¯ä»¥ä¾¿å¿«é€Ÿå›æ»šã€‚

### åˆ‡æ¢å‰
- ä¸»åº“: Prisma
- å½±å­åº“: Supabase
- è¿”å›ç»™ç”¨æˆ·: Prisma çš„æŸ¥è¯¢ç»“æœ

### åˆ‡æ¢å
- ä¸»åº“: Supabase
- å½±å­åº“: Prisma
- è¿”å›ç»™ç”¨æˆ·: Supabase çš„æŸ¥è¯¢ç»“æœ

---

## âœ… åˆ‡æ¢å‰æ£€æŸ¥æ¸…å•

### 1. æ•°æ®ä¸€è‡´æ€§éªŒè¯
- [ ] æ£€æŸ¥åŒå†™ diff æ•°é‡ï¼ˆç›®æ ‡ < 5 ä¸ªå·®å¼‚/å¤©ï¼‰
- [ ] æŸ¥çœ‹æœ€è¿‘ 7 å¤©çš„ diff è®°å½•æ˜¯å¦æœ‰ä¸¥é‡ä¸ä¸€è‡´
- [ ] éªŒè¯å…³é”®ä¸šåŠ¡æ•°æ®ï¼šé¢„ç®—ã€æ”¯å‡ºã€é€šçŸ¥

**æ£€æŸ¥å‘½ä»¤**:
```bash
npx tsx scripts/dual-write/view-diff-details.ts --days=7
```

### 2. RPC å‡½æ•°éªŒè¯
- [x] `record_spending_tx` - å·²å®Œæˆ P0 ä¿®å¤
- [x] `accept_family_invite` - å·²å®Œæˆ P0 ä¿®å¤
- [x] `create_inventory_notifications_batch` - å·²å®Œæˆ P0 ä¿®å¤
- [x] `update_shopping_list_item_atomic` - å·²å®Œæˆ P0 ä¿®å¤

### 3. é”™è¯¯ç‡æ£€æŸ¥
- [ ] Supabase é”™è¯¯ç‡ < 0.5%
- [ ] åŒå†™æˆåŠŸç‡ > 99%
- [ ] API å“åº”æˆåŠŸç‡ > 99.9%

### 4. æ€§èƒ½åŸºçº¿
- [ ] P95 å»¶è¿Ÿ < 200ms
- [ ] æ•°æ®åº“è¿æ¥æ± ç¨³å®š
- [ ] æ²¡æœ‰æ…¢æŸ¥è¯¢å‘Šè­¦

### 5. å›æ»šå‡†å¤‡
- [x] å›æ»šè„šæœ¬å¯ç”¨ (`toggle-feature-flags.ts`)
- [ ] å›¢é˜Ÿæˆå‘˜çŸ¥æ™“å›æ»šæµç¨‹
- [ ] ç›‘æ§é¢æ¿å·²å°±ç»ª

---

## ğŸ“‹ åˆ‡æ¢æ­¥éª¤

### Step 1: å‡†å¤‡å·¥ä½œ (5 åˆ†é’Ÿ)

1. **é€šçŸ¥ç›¸å…³äººå‘˜**
   ```
   ğŸ“¢ ä¸»åº“åˆ‡æ¢é€šçŸ¥

   æ—¶é—´: 2025-11-17 [å…·ä½“æ—¶é—´]
   æ“ä½œ: Prisma â†’ Supabase ä¸»åº“åˆ‡æ¢
   é¢„è®¡å½±å“: æ— ï¼ˆä¿æŒåŒå†™æ¨¡å¼ï¼‰
   å›æ»šæ–¹æ¡ˆ: 5 åˆ†é’Ÿå†…å¯åˆ‡å›
   ```

2. **å¤‡ä»½å½“å‰é…ç½®**
   ```bash
   npx tsx scripts/check-feature-flags.ts > /tmp/feature-flags-backup.txt
   ```

3. **æ£€æŸ¥ç³»ç»Ÿå¥åº·çŠ¶å†µ**
   ```bash
   # æ£€æŸ¥æ•°æ®åº“è¿æ¥
   pnpm db:test

   # æ£€æŸ¥ diff ç»Ÿè®¡
   npx tsx scripts/check-dual-write-diffs.ts
   ```

### Step 2: æ‰§è¡Œåˆ‡æ¢ (2 åˆ†é’Ÿ)

```bash
# åˆ‡æ¢åˆ° Supabase ä¸ºä¸»ï¼ˆä¿æŒåŒå†™ï¼‰
npx tsx scripts/dual-write/toggle-feature-flags.ts --primary=supabase

# é¢„æœŸè¾“å‡º:
# ğŸ“ å‡†å¤‡æ›´æ–°é…ç½®:
#   enableDualWrite: true â†’ true
#   enableSupabasePrimary: false â†’ true
#
# ğŸ“‹ æ–°æ¨¡å¼: åŒå†™æ¨¡å¼ - Supabase ä¸ºä¸», Prisma ä¸ºå½±å­
#
# âš ï¸  è­¦å‘Š: æ­¤æ“ä½œå°†ç«‹å³ç”Ÿæ•ˆ,å½±å“æ‰€æœ‰æ­£åœ¨è¿è¡Œçš„å®ä¾‹!
# ç¡®è®¤æ›´æ–°? (æŒ‰ Ctrl+C å–æ¶ˆ,æˆ–ç­‰å¾… 3 ç§’è‡ªåŠ¨ç»§ç»­)
#
# âœ… æ›´æ–°æˆåŠŸ!
# ğŸ’¡ æç¤º: ç¼“å­˜åˆ·æ–°éœ€è¦æœ€å¤š 5 ç§’,è¯·ç­‰å¾…ç”Ÿæ•ˆã€‚
```

### Step 3: éªŒè¯åˆ‡æ¢ (10-15 åˆ†é’Ÿ)

1. **ç¡®è®¤é…ç½®ç”Ÿæ•ˆ** (ç­‰å¾… 5-10 ç§’ç¼“å­˜åˆ·æ–°)
   ```bash
   npx tsx scripts/check-feature-flags.ts

   # é¢„æœŸè¾“å‡º:
   # - enableDualWrite: âœ… å¼€å¯
   # - enableSupabasePrimary: âœ… Supabase ä¸ºä¸»
   ```

2. **åŠŸèƒ½éªŒè¯** - æµ‹è¯•å…³é”®ç«¯ç‚¹

   **è´¢åŠ¡ç«¯ç‚¹æµ‹è¯•**:
   ```bash
   # æµ‹è¯•é¢„ç®—æŸ¥è¯¢
   curl -X GET "http://localhost:3000/api/budget/current?memberId=xxx"

   # æµ‹è¯•æ”¯å‡ºè®°å½•
   curl -X POST "http://localhost:3000/api/budget/record-spending" \
     -H "Content-Type: application/json" \
     -d '{
       "budgetId": "xxx",
       "amount": 50,
       "category": "VEGETABLES",
       "description": "æµ‹è¯•æ”¯å‡º"
     }'
   ```

   **é€šçŸ¥ç«¯ç‚¹æµ‹è¯•**:
   ```bash
   # æµ‹è¯•é€šçŸ¥åˆ—è¡¨
   curl -X GET "http://localhost:3000/api/inventory/notifications?memberId=xxx"

   # æµ‹è¯•æ‰¹é‡æ“ä½œ
   curl -X POST "http://localhost:3000/api/notifications/batch" \
     -H "Content-Type: application/json" \
     -d '{
       "operation": "create",
       "data": {
         "notifications": [...]
       }
     }'
   ```

   **å®¶åº­é‚€è¯·æµ‹è¯•**:
   ```bash
   # æµ‹è¯•é‚€è¯·æŸ¥è¯¢
   curl -X GET "http://localhost:3000/api/invite/test-code"
   ```

3. **é”™è¯¯ç‡ç›‘æ§** (æŒç»­ 15 åˆ†é’Ÿ)
   - æŸ¥çœ‹åº”ç”¨æ—¥å¿—ï¼Œç¡®è®¤æ— å¼‚å¸¸é”™è¯¯
   - æ£€æŸ¥ Supabase æ—¥å¿—ï¼Œç¡®è®¤æŸ¥è¯¢æ­£å¸¸
   - è§‚å¯Ÿ API å“åº”æ—¶é—´

4. **æ•°æ®ä¸€è‡´æ€§æŠ½æŸ¥**
   ```bash
   # æŸ¥çœ‹æ–°äº§ç”Ÿçš„ diff
   npx tsx scripts/dual-write/view-diff-details.ts --days=1 --limit=20

   # é¢„æœŸï¼šdiff æ•°é‡åº”è¯¥ä¿æŒç¨³å®šæˆ–å‡å°‘
   ```

### Step 4: æ€§èƒ½å¯¹æ¯” (10 åˆ†é’Ÿ)

1. **è¿è¡Œ k6 æ€§èƒ½æµ‹è¯•**
   ```bash
   cd scripts/performance
   ./run-comparison.sh
   ```

2. **å¯¹æ¯”æŒ‡æ ‡**:
   - P95 å»¶è¿Ÿå˜åŒ– < 20%
   - é”™è¯¯ç‡ < 0.1%
   - ååé‡ä¿æŒç¨³å®š

---

## ğŸ”„ å›æ»šæ–¹æ¡ˆ

### åœºæ™¯ 1: Supabase å‡ºç°å¤§é‡é”™è¯¯

**ç—‡çŠ¶**: Supabase é”™è¯¯ç‡ > 1%ï¼Œæˆ–å‡ºç°å¤§é‡ timeout

**å›æ»šæ­¥éª¤**:
```bash
# 1. ç«‹å³åˆ‡å› Prisma ä¸ºä¸»
npx tsx scripts/dual-write/toggle-feature-flags.ts --primary=prisma

# 2. ç­‰å¾… 5 ç§’ç¼“å­˜åˆ·æ–°
sleep 5

# 3. éªŒè¯é…ç½®
npx tsx scripts/check-feature-flags.ts

# 4. æµ‹è¯•å…³é”®ç«¯ç‚¹
curl -X GET "http://localhost:3000/api/budget/current?memberId=xxx"

# é¢„è®¡æ¢å¤æ—¶é—´: < 30 ç§’
```

### åœºæ™¯ 2: æ•°æ®ä¸ä¸€è‡´ä¸¥é‡

**ç—‡çŠ¶**: diff è®°å½•æ˜¾ç¤ºå¤§é‡å­—æ®µä¸åŒ¹é…

**å›æ»šæ­¥éª¤**:
```bash
# 1. åˆ‡å› Prisma ä¸ºä¸»
npx tsx scripts/dual-write/toggle-feature-flags.ts --primary=prisma

# 2. è¿è¡Œæ•°æ®å¯¹è´¦è„šæœ¬
npx tsx scripts/dual-write/reconcile-data.ts --entity=Budget --fix

# 3. æ£€æŸ¥å¯¹è´¦ç»“æœ
cat /tmp/reconcile-report-*.json

# é¢„è®¡æ¢å¤æ—¶é—´: 5-10 åˆ†é’Ÿ
```

### åœºæ™¯ 3: æ€§èƒ½é€€åŒ–ä¸¥é‡

**ç—‡çŠ¶**: P95 å»¶è¿Ÿ > 200ms æˆ–è¶…è¿‡ Prisma åŸºçº¿çš„ 150%

**å›æ»šæ­¥éª¤**:
```bash
# 1. åˆ‡å› Prisma ä¸ºä¸»
npx tsx scripts/dual-write/toggle-feature-flags.ts --primary=prisma

# 2. åˆ†ææ€§èƒ½ç“¶é¢ˆ
# - æ£€æŸ¥ Supabase æ…¢æŸ¥è¯¢æ—¥å¿—
# - å®¡æŸ¥ RPC å‡½æ•°æ€§èƒ½
# - éªŒè¯ç´¢å¼•æ˜¯å¦ç”Ÿæ•ˆ

# 3. ä¿®å¤åé‡æ–°åˆ‡æ¢
```

---

## ğŸ“ˆ ç›‘æ§æŒ‡æ ‡

### åˆ‡æ¢åæŒç»­ç›‘æ§ï¼ˆ7 å¤©ï¼‰

| æŒ‡æ ‡ | ç›®æ ‡ | ç›‘æ§é¢‘ç‡ |
|------|------|---------|
| API æˆåŠŸç‡ | > 99.9% | å®æ—¶ |
| Supabase é”™è¯¯ç‡ | < 0.5% | å®æ—¶ |
| P95 å»¶è¿Ÿ | < 200ms | æ¯ 5 åˆ†é’Ÿ |
| åŒå†™ diff æ•°é‡ | < 10/å¤© | æ¯å°æ—¶ |
| æ•°æ®ä¸€è‡´æ€§ | 100% (å…³é”®æ•°æ®) | æ¯æ—¥ |

### å‘Šè­¦è§¦å‘æ¡ä»¶

- âŒ Supabase é”™è¯¯ç‡ > 1%ï¼ˆç«‹å³å‘Šè­¦ï¼‰
- âš ï¸ P95 å»¶è¿Ÿ > 300msï¼ˆè­¦å‘Šï¼‰
- âš ï¸ Diff æ•°é‡ > 50/å¤©ï¼ˆè­¦å‘Šï¼‰
- âŒ å…³é”®æ•°æ®ä¸ä¸€è‡´ï¼ˆç«‹å³å‘Šè­¦ï¼‰

---

## ğŸ‰ åˆ‡æ¢å®Œæˆæ ‡å‡†

æ»¡è¶³ä»¥ä¸‹æ‰€æœ‰æ¡ä»¶ï¼Œå¯è¿›å…¥ä¸‹ä¸€é˜¶æ®µï¼ˆPrisma é™çº§ä¸ºå½±å­å†™ï¼‰ï¼š

1. âœ… åˆ‡æ¢åè¿è¡Œ **3 å¤©** æ— ä¸¥é‡é—®é¢˜
2. âœ… Supabase é”™è¯¯ç‡ **< 0.5%**
3. âœ… åŒå†™ diff æ•°é‡ **< 5 ä¸ª/å¤©**
4. âœ… P95 å»¶è¿Ÿ **< 200ms**
5. âœ… å…³é”®ä¸šåŠ¡åŠŸèƒ½éªŒè¯é€šè¿‡

---

## ğŸ“ åˆ‡æ¢æ—¥å¿—æ¨¡æ¿

```
=== ä¸»åº“åˆ‡æ¢æ—¥å¿— ===

æ‰§è¡Œäºº: [å§“å]
æ‰§è¡Œæ—¶é—´: [YYYY-MM-DD HH:MM:SS]

åˆ‡æ¢å‰çŠ¶æ€:
- Feature Flags: enableDualWrite=true, enableSupabasePrimary=false
- Supabase é”™è¯¯ç‡: [X%]
- Diff æ•°é‡(æœ€è¿‘ 24h): [N ä¸ª]

åˆ‡æ¢æ“ä½œ:
[æ—¶é—´] å¤‡ä»½å½“å‰é…ç½®
[æ—¶é—´] æ‰§è¡Œåˆ‡æ¢å‘½ä»¤
[æ—¶é—´] éªŒè¯é…ç½®ç”Ÿæ•ˆ

åˆ‡æ¢åéªŒè¯:
[æ—¶é—´] åŠŸèƒ½æµ‹è¯• - [é€šè¿‡/å¤±è´¥]
[æ—¶é—´] æ€§èƒ½æµ‹è¯• - [é€šè¿‡/å¤±è´¥]
[æ—¶é—´] é”™è¯¯ç‡æ£€æŸ¥ - [é€šè¿‡/å¤±è´¥]

é—®é¢˜å’Œè§£å†³:
- [å¦‚æœ‰é—®é¢˜è®°å½•åœ¨æ­¤]

ç»“è®º: [æˆåŠŸ/å¤±è´¥/å›æ»š]
```

---

## ğŸ” å®‰å…¨æ£€æŸ¥

- [ ] åˆ‡æ¢æ“ä½œä»…å½±å“è¯»å†™è·¯ç”±ï¼Œä¸ä¿®æ”¹æ•°æ®
- [ ] ä¿æŒåŒå†™æ¨¡å¼ï¼ŒPrisma ä»ç„¶æ¥æ”¶æ‰€æœ‰å†™æ“ä½œ
- [ ] å›æ»šæ—¶é—´ < 5 åˆ†é’Ÿ
- [ ] æ— éœ€åœæœºç»´æŠ¤
- [ ] ç”¨æˆ·æ— æ„ŸçŸ¥åˆ‡æ¢

---

## ğŸ“š å‚è€ƒèµ„æ–™

- **åŒå†™æ¡†æ¶æ–‡æ¡£**: `scripts/dual-write/README.md`
- **Feature Flag æ–‡æ¡£**: `src/lib/db/dual-write/feature-flags.ts`
- **å›æ»šæ“ä½œæ‰‹å†Œ**: `scripts/dual-write/README.md#å›æ»šæµç¨‹`
- **ç›‘æ§ä»ªè¡¨ç›˜**: `scripts/monitoring/grafana-dashboard.json`

---

**æ‰¹å‡†ç­¾å­—**:

- [ ] æŠ€æœ¯è´Ÿè´£äºº: ___________ æ—¥æœŸ: ___________
- [ ] æ‰§è¡Œäºº: ___________ æ—¥æœŸ: ___________
