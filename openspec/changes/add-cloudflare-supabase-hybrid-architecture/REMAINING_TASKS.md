# å‰©ä½™ä»»åŠ¡æ¸…å• - Cloudflare + Supabase æ··åˆæ¶æ„

**åˆ›å»ºæ—¶é—´**: 2025-11-17
**çŠ¶æ€**: ğŸ”´ ç”Ÿäº§éƒ¨ç½²è¢«é˜»å¡
**åŸå› **: React Context SSR é¢„æ¸²æŸ“é”™è¯¯

---

## âš ï¸ é«˜ä¼˜å…ˆçº§ä»»åŠ¡ï¼ˆé˜»å¡ç”Ÿäº§éƒ¨ç½²ï¼‰

### ä»»åŠ¡ 1: ä¿®å¤ React Context é¢„æ¸²æŸ“é”™è¯¯

**ä¸¥é‡æ€§**: ğŸ”´ é˜»å¡æ€§ï¼ˆBlockerï¼‰
**å½±å“èŒƒå›´**: æ‰€æœ‰ä¸»è¦é¡µé¢æ— æ³•éƒ¨ç½²åˆ° Cloudflare Pages
**é¢„è®¡æ—¶é—´**: 30-60 åˆ†é’Ÿ

#### é”™è¯¯æè¿°

Next.js åœ¨é™æ€ç”Ÿæˆï¼ˆSSGï¼‰é˜¶æ®µå°è¯•é¢„æ¸²æŸ“ä½¿ç”¨ React Context çš„é¡µé¢æ—¶å¤±è´¥ï¼š

```
TypeError: Cannot read properties of null (reading 'useContext')
```

#### å—å½±å“é¡µé¢

- `/` - é¦–é¡µ
- `/dashboard` - ä»ªè¡¨æ¿
- `/onboarding` - ç”¨æˆ·å¼•å¯¼
- `/shopping-list` - è´­ç‰©æ¸…å•
- `/meal-planning` - è†³é£Ÿè®¡åˆ’
- `/health-tracking` - å¥åº·è¿½è¸ª
- `/budget` - é¢„ç®—ç®¡ç†
- å…¶ä»–æ‰€æœ‰ä½¿ç”¨ Context çš„é¡µé¢

#### æ ¹æœ¬åŸå› 

Next.js 15 åœ¨ `output: 'standalone'` æ¨¡å¼ä¸‹é»˜è®¤å°è¯•é™æ€ç”Ÿæˆæ‰€æœ‰é¡µé¢ï¼Œä½† React Context åœ¨æœåŠ¡å™¨ç«¯æ¸²æŸ“ï¼ˆSSRï¼‰æ—¶ä¸º `null`ã€‚

#### è§£å†³æ–¹æ¡ˆï¼ˆä¸‰é€‰ä¸€ï¼‰

**æ–¹æ¡ˆ Aï¼šæ·»åŠ  'use client' æŒ‡ä»¤ï¼ˆæ¨èï¼‰**

ä¸ºæ‰€æœ‰ä½¿ç”¨ Context çš„é¡µé¢ç»„ä»¶æ·»åŠ å®¢æˆ·ç«¯æ¸²æŸ“æŒ‡ä»¤ï¼š

```typescript
// src/app/dashboard/page.tsx
'use client'

export default function DashboardPage() {
  // ...
}
```

- âœ… ä¼˜ç‚¹ï¼šç®€å•å¿«é€Ÿï¼Œä¸æ”¹å˜åº”ç”¨æ¶æ„
- âŒ ç¼ºç‚¹ï¼šå¤±å» SSR çš„ SEO å’Œæ€§èƒ½ä¼˜åŠ¿

**æ–¹æ¡ˆ Bï¼šç¦ç”¨é™æ€ç”Ÿæˆ**

åœ¨ `next.config.js` ä¸­é…ç½®åŠ¨æ€è·¯ç”±ï¼š

```javascript
// next.config.js
module.exports = {
  // ...
  experimental: {
    isrMemoryCacheSize: 0,
  },
  // æˆ–åœ¨æ¯ä¸ªé¡µé¢æ·»åŠ :
  // export const dynamic = 'force-dynamic'
}
```

- âœ… ä¼˜ç‚¹ï¼šä¿ç•™ SSR èƒ½åŠ›
- âŒ ç¼ºç‚¹ï¼šå¯èƒ½å½±å“ Cloudflare Pages éƒ¨ç½²é…ç½®

**æ–¹æ¡ˆ Cï¼šé‡æ„ Context æ¶æ„ï¼ˆæœ€ä¼˜ä½†è€—æ—¶ï¼‰**

å°† Context ä½¿ç”¨é™åˆ¶åœ¨å®¢æˆ·ç«¯ç»„ä»¶ä¸­ï¼ŒæœåŠ¡ç«¯ç»„ä»¶ä»…ä¼ é€’æ•°æ®ï¼š

```typescript
// app/dashboard/page.tsx (Server Component)
export default function DashboardPage() {
  // æœåŠ¡ç«¯æ•°æ®è·å–
  const data = await fetchData()

  return <DashboardClient initialData={data} />
}

// components/DashboardClient.tsx
'use client'
export function DashboardClient({ initialData }) {
  // å®¢æˆ·ç«¯ Context ä½¿ç”¨
}
```

- âœ… ä¼˜ç‚¹ï¼šéµå¾ª Next.js 15 æœ€ä½³å®è·µï¼Œæ€§èƒ½å’Œ SEO æœ€ä¼˜
- âŒ ç¼ºç‚¹ï¼šéœ€è¦é‡æ„å¤§é‡ä»£ç ï¼ˆ2-4 å°æ—¶ï¼‰

#### å®æ–½æ­¥éª¤ï¼ˆæ–¹æ¡ˆ A - æ¨èå¿«é€Ÿè§£å†³ï¼‰

1. è¯†åˆ«æ‰€æœ‰ä½¿ç”¨ Context çš„é¡µé¢æ–‡ä»¶
2. åœ¨æ–‡ä»¶é¡¶éƒ¨æ·»åŠ  `'use client'`
3. è¿è¡Œ `pnpm build:cloudflare` éªŒè¯
4. éƒ¨ç½²åˆ° Cloudflare Pages
5. åŠŸèƒ½æµ‹è¯•

#### éªŒæ”¶æ ‡å‡†

- [ ] `pnpm build:cloudflare` æ— é¢„æ¸²æŸ“é”™è¯¯
- [ ] éƒ¨ç½²åˆ° Cloudflare Pages æˆåŠŸ
- [ ] æ‰€æœ‰é¡µé¢å¯æ­£å¸¸è®¿é—®
- [ ] Context åŠŸèƒ½æ­£å¸¸ï¼ˆè®¤è¯ã€çŠ¶æ€ç®¡ç†ç­‰ï¼‰

---

## ğŸ”¶ ä¸­ä¼˜å…ˆçº§ä»»åŠ¡ï¼ˆæŠ€æœ¯å€ºï¼‰

### ä»»åŠ¡ 2: ç³»ç»Ÿæ€§ä¿®å¤ TypeScript ç±»å‹é”™è¯¯

**ä¸¥é‡æ€§**: ğŸŸ¡ ä¸­ç­‰ï¼ˆä¸é˜»å¡éƒ¨ç½²ï¼Œä½†å½±å“ä»£ç è´¨é‡ï¼‰
**å½±å“èŒƒå›´**: 2000+ ç±»å‹é”™è¯¯
**é¢„è®¡æ—¶é—´**: 2-3 å°æ—¶

#### é”™è¯¯åˆ†ç±»

**ç±»åˆ« 1: Repository å±‚ç±»å‹ä¸åŒ¹é… (çº¦ 2000 ä¸ªé”™è¯¯)**

```typescript
// å½“å‰é—®é¢˜ï¼šRepository è¿”å›ç±»å‹ä¸º unknown/never
const result = await repository.findById(id)
//    ^? unknown - æ— æ³•æ¨æ–­æ­£ç¡®ç±»å‹

// æœŸæœ›ï¼šæ˜ç¡®çš„ Prisma/Supabase ç±»å‹
const result = await repository.findById(id)
//    ^? Budget | null
```

**å—å½±å“æ–‡ä»¶**:
- `src/app/api/**/route.ts` - æ‰€æœ‰ API è·¯ç”± (2000+ errors)
- `src/lib/repositories/**/*.ts` - Repository å®ç°
- `src/lib/services/**/*.ts` - æœåŠ¡å±‚

**æ ¹æœ¬åŸå› **: Repository æ¥å£åœ¨ Prisma å’Œ Supabase å®ç°ä¹‹é—´ç±»å‹å®šä¹‰ä¸ä¸€è‡´ã€‚

**è§£å†³æ–¹æ¡ˆ**:
1. ç»Ÿä¸€ `IRepository<T>` æ³›å‹æ¥å£å®šä¹‰
2. ä¸º Prisma å’Œ Supabase Repository åˆ†åˆ«æä¾›æ­£ç¡®çš„ç±»å‹å‚æ•°
3. ä½¿ç”¨ TypeScript æ¡ä»¶ç±»å‹ç¡®ä¿è¿”å›å€¼ç±»å‹å®‰å…¨

**ç±»åˆ« 2: æµ‹è¯•æ–‡ä»¶ç±»å‹é”™è¯¯ (çº¦ 100 ä¸ªé”™è¯¯)**

```typescript
// é—®é¢˜ï¼šMock å¯¹è±¡ç±»å‹ä¸åŒ¹é…æ–°çš„ Repository æ¥å£
const mockRepository = {
  findById: jest.fn(),
  // ç¼ºå°‘æ–°å¢çš„æ–¹æ³•ç­¾å
}
```

**å—å½±å“æ–‡ä»¶**:
- `src/__tests__/**/*.test.ts` - æ‰€æœ‰æµ‹è¯•æ–‡ä»¶

**è§£å†³æ–¹æ¡ˆ**:
1. æ›´æ–°æ‰€æœ‰ Repository mock å¯¹è±¡ä»¥åŒ¹é…æ–°æ¥å£
2. ä½¿ç”¨ `jest.MockedObject<T>` ç±»å‹ç¡®ä¿ mock ç±»å‹å®‰å…¨
3. æ·»åŠ ç¼ºå¤±çš„ Supabase ç›¸å…³ mock æ–¹æ³•

**ç±»åˆ« 3: è„šæœ¬å’Œé…ç½®æ–‡ä»¶ (çº¦ 47 ä¸ªé”™è¯¯)**

**å—å½±å“æ–‡ä»¶**:
- `scripts/**/*.ts`
- `src/middleware.ts`

**è§£å†³æ–¹æ¡ˆ**:
1. ä¸ºè„šæœ¬æ·»åŠ é€‚å½“çš„ç±»å‹æ³¨è§£
2. ä¿®å¤ middleware ç±»å‹é—®é¢˜

**ç±»åˆ« 4: ç¼ºå¤±æ¨¡å—å£°æ˜ (çº¦ 11 ä¸ªé”™è¯¯)**

```
Cannot find module '@sentry/nextjs' or its corresponding type declarations
```

**è§£å†³æ–¹æ¡ˆ**:
1. æ£€æŸ¥æ˜¯å¦å·²å®‰è£… `@sentry/nextjs`
2. å¦‚æœªä½¿ç”¨ï¼Œç§»é™¤ç›¸å…³å¼•ç”¨
3. å¦‚éœ€ä½¿ç”¨ï¼Œå®‰è£…æ­£ç¡®ç‰ˆæœ¬å¹¶é…ç½®

#### å®æ–½è®¡åˆ’

**é˜¶æ®µ 1: Repository ç±»å‹ä¿®å¤ (90 åˆ†é’Ÿ)**
1. å®šä¹‰ç»Ÿä¸€çš„ `IRepository<T>` æ³›å‹æ¥å£
2. æ›´æ–° `PrismaRepository<T>` ç±»å‹å®šä¹‰
3. æ›´æ–° `SupabaseRepository<T>` ç±»å‹å®šä¹‰
4. éªŒè¯æ‰€æœ‰ API è·¯ç”±ç±»å‹æ¨æ–­æ­£ç¡®

**é˜¶æ®µ 2: æµ‹è¯•æ–‡ä»¶ä¿®å¤ (30 åˆ†é’Ÿ)**
1. åˆ›å»ºç»Ÿä¸€çš„ Repository mock å·¥å‚å‡½æ•°
2. æ‰¹é‡æ›´æ–°æµ‹è¯•æ–‡ä»¶ mock å¯¹è±¡
3. è¿è¡Œæµ‹è¯•ç¡®ä¿æ— å›å½’

**é˜¶æ®µ 3: æ‚é¡¹ä¿®å¤ (30 åˆ†é’Ÿ)**
1. ä¿®å¤è„šæœ¬ç±»å‹é”™è¯¯
2. å¤„ç†ç¼ºå¤±æ¨¡å—å£°æ˜
3. å…¨é‡ç±»å‹æ£€æŸ¥éªŒè¯

#### éªŒæ”¶æ ‡å‡†

- [ ] `pnpm type-check` é›¶é”™è¯¯
- [ ] `pnpm test` å…¨éƒ¨é€šè¿‡
- [ ] æ‰€æœ‰ Repository è°ƒç”¨æœ‰æ­£ç¡®çš„ç±»å‹æ¨æ–­
- [ ] IDE ä¸­æ— ç±»å‹é”™è¯¯æç¤º

---

## ğŸ”µ ä½ä¼˜å…ˆçº§ä»»åŠ¡ï¼ˆä¼˜åŒ–å’Œç›‘æ§ï¼‰

### ä»»åŠ¡ 3: Supabase ä¸»åº“åˆ‡æ¢éªŒè¯

**ä¸¥é‡æ€§**: ğŸŸ¢ ä½ï¼ˆåŠŸèƒ½å·²å¯ç”¨ï¼Œéœ€éªŒè¯ï¼‰
**é¢„è®¡æ—¶é—´**: 30 åˆ†é’Ÿ

#### éªŒè¯æ¸…å•

**æœ¬åœ°åŠŸèƒ½æµ‹è¯•**:
- [ ] å¯åŠ¨æœ¬åœ°å¼€å‘æœåŠ¡å™¨ `pnpm dev`
- [ ] éªŒè¯ç”¨æˆ·ç™»å½•/æ³¨å†Œ
- [ ] æµ‹è¯•é¢„ç®—åˆ›å»ºå’ŒæŸ¥è¯¢ï¼ˆSupabase ä¸»è¯»å†™ï¼‰
- [ ] æ£€æŸ¥å¼€å‘å·¥å…·æ§åˆ¶å°æ—  Supabase é”™è¯¯
- [ ] éªŒè¯åŒå†™æ—¥å¿—è®°å½•æ­£å¸¸

**æ•°æ®åº“ä¸€è‡´æ€§æ£€æŸ¥**:
- [ ] è¿è¡Œ `npx tsx scripts/check-feature-flags.ts` ç¡®è®¤é…ç½®
- [ ] æ£€æŸ¥ `dual_write_diffs` è¡¨æœ€è¿‘ 24 å°æ—¶æ•°æ®
- [ ] ç¡®è®¤æ—  `error` çº§åˆ« diff è®°å½•
- [ ] éªŒè¯ Prisma å½±å­å†™æ­£å¸¸æ‰§è¡Œ

**æ€§èƒ½ç›‘æ§**:
- [ ] å¯¹æ¯” Supabase æŸ¥è¯¢å»¶è¿Ÿ vs Prismaï¼ˆé¢„æœŸ < 200msï¼‰
- [ ] æ£€æŸ¥ API æˆåŠŸç‡ï¼ˆç›®æ ‡ > 99.9%ï¼‰
- [ ] ç›‘æ§ Supabase è¿æ¥æ± çŠ¶æ€

#### æµ‹è¯•è„šæœ¬

```bash
# 1. éªŒè¯åŠŸèƒ½æ ‡å¿—
npx tsx scripts/check-feature-flags.ts

# 2. æ£€æŸ¥æœ€è¿‘ diff è®°å½•
npx tsx scripts/dual-write/check-diffs.ts --hours=24

# 3. æœ¬åœ°å¼€å‘æµ‹è¯•
pnpm dev
# æµè§ˆå™¨è®¿é—® http://localhost:3000
# æ‰§è¡Œä¸Šè¿°åŠŸèƒ½æµ‹è¯•

# 4. æ•°æ®åº“è¿æ¥æµ‹è¯•
pnpm db:test
pnpm supabase:test
```

---

### ä»»åŠ¡ 4: ç”Ÿäº§éƒ¨ç½²å’Œç›‘æ§

**å‰ç½®æ¡ä»¶**: ä»»åŠ¡ 1 å¿…é¡»å®Œæˆ
**é¢„è®¡æ—¶é—´**: 20 åˆ†é’Ÿéƒ¨ç½² + æŒç»­ç›‘æ§

#### éƒ¨ç½²æ­¥éª¤

```bash
# 1. ç¡®ä¿æ‰€æœ‰æ›´æ”¹å·²æäº¤
git status

# 2. æ‰§è¡Œéƒ¨ç½²
pnpm deploy:prod
# æˆ–
./scripts/deploy-cloudflare-supabase.sh production

# 3. éªŒè¯éƒ¨ç½²
pnpm check:deployment
```

#### ç›‘æ§è®¡åˆ’

**å³æ—¶æ£€æŸ¥ï¼ˆéƒ¨ç½²å 15 åˆ†é’Ÿï¼‰**:
- [ ] è®¿é—® https://hearthbulter.pages.dev
- [ ] æµ‹è¯•ç”¨æˆ·ç™»å½•
- [ ] æ£€æŸ¥ Cloudflare Pages æ—¥å¿—æ— å¼‚å¸¸
- [ ] éªŒè¯ Supabase Dashboard æŸ¥è¯¢æ­£å¸¸

**çŸ­æœŸç›‘æ§ï¼ˆ24 å°æ—¶ï¼‰**:
- [ ] åŒå†™ Diff æ•°é‡ < 10/å¤©
- [ ] API æˆåŠŸç‡ > 99.9%
- [ ] P95 å»¶è¿Ÿ < 200ms
- [ ] æ—  5xx é”™è¯¯

**ä¸­æœŸç›‘æ§ï¼ˆ3-7 å¤©ï¼‰**:
- [ ] Supabase é”™è¯¯ç‡ < 0.5%
- [ ] ç”¨æˆ·æ— å…³é”®ä¸šåŠ¡é—®é¢˜åé¦ˆ
- [ ] æ€§èƒ½æŒ‡æ ‡ç¨³å®š

#### å›æ»šå‡†å¤‡

å¦‚é‡ä¸¥é‡é—®é¢˜ï¼Œæ‰§è¡Œå›æ»šï¼š

```bash
# åˆ‡å› Prisma ä¸ºä¸»
npx tsx scripts/dual-write/toggle-feature-flags.ts --primary=prisma

# éªŒè¯å›æ»š
npx tsx scripts/check-feature-flags.ts
```

**é¢„è®¡å›æ»šæ—¶é—´**: < 5 åˆ†é’Ÿ

---

## ğŸ“Š ä»»åŠ¡ä¼˜å…ˆçº§å’Œæ—¶é—´ä¼°ç®—

| ä»»åŠ¡ | ä¼˜å…ˆçº§ | é¢„è®¡æ—¶é—´ | é˜»å¡éƒ¨ç½² | å»ºè®®æ‰§è¡Œé¡ºåº |
|------|--------|----------|----------|--------------|
| ä¿®å¤ React Context é”™è¯¯ | ğŸ”´ é«˜ | 30-60 åˆ†é’Ÿ | âœ… æ˜¯ | 1 |
| éªŒè¯ Supabase æœ¬åœ°åŠŸèƒ½ | ğŸŸ¢ ä½ | 30 åˆ†é’Ÿ | âŒ å¦ | 2 |
| ç”Ÿäº§éƒ¨ç½²å’Œç›‘æ§ | ğŸ”´ é«˜ | 20 åˆ†é’Ÿ + æŒç»­ | ä¾èµ–ä»»åŠ¡1 | 3 |
| ç³»ç»Ÿæ€§ä¿®å¤ç±»å‹é”™è¯¯ | ğŸŸ¡ ä¸­ | 2-3 å°æ—¶ | âŒ å¦ | 4 |

**æ€»ä¼°ç®—**: 4-5 å°æ—¶å®Œæˆæ‰€æœ‰ä»»åŠ¡

---

## ğŸ“ å·²å®Œæˆå·¥ä½œ

âœ… **Supabase ç±»å‹å®šä¹‰ä¿®å¤**
- æ·»åŠ  `dual_write_config` è¡¨ç±»å‹
- æ·»åŠ  `dual_write_diffs` è¡¨ç±»å‹
- æ·»åŠ  `DualWriteFeatureFlagsValue` è¾…åŠ©ç±»å‹

âœ… **éƒ¨ç½²è„šæœ¬ä¿®å¤**
- ä¿®æ­£ `scripts/deploy-cloudflare-supabase.sh` æ„å»ºå‘½ä»¤
- ä» `pnpm build` æ”¹ä¸º `pnpm build:cloudflare`

âœ… **Git æäº¤**
- æäº¤ ID: `89f476e`
- æäº¤ä¿¡æ¯: "feat: åˆ‡æ¢ Supabase ä¸ºä¸»æ•°æ®åº“"
- åŒ…å« 6 ä¸ª API è·¯ç”±ä¿®æ”¹å’ŒåŒå†™é…ç½®æ›´æ–°

âœ… **æ•°æ®åº“é…ç½®**
- `enableDualWrite`: true
- `enableSupabasePrimary`: true
- æ›´æ–°æ—¶é—´: 2025-11-17T07:52:11.381+00:00

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- ä¸»åˆ‡æ¢è®¡åˆ’: `PRIMARY_SWITCH_PLAN.md`
- åˆ‡æ¢æ—¥å¿—: `SWITCH_LOG_2025-11-17.md`
- ä»»åŠ¡è¿½è¸ª: `tasks.md`
- åŒå†™æ¡†æ¶: `scripts/dual-write/README.md`
- éƒ¨ç½²è„šæœ¬: `scripts/deploy-cloudflare-supabase.sh`

---

**åˆ›å»ºè€…**: Claude Code
**æœ€åæ›´æ–°**: 2025-11-17
**çŠ¶æ€**: ğŸ“‹ å¾…æ‰§è¡Œ
