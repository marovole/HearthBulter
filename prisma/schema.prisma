generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id               String            @id @default(cuid())
  email            String            @unique
  emailVerified    DateTime?
  name             String?
  image            String?
  password         String?
  role             UserRole          @default(USER)
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  deletedAt        DateTime?
  createdFamilies  Family[]          @relation("FamilyCreator")
  familyMembers    FamilyMember?
  orders           Order[]           @relation("UserOrders")
  platformAccounts PlatformAccount[] @relation("PlatformAccounts")

  @@map("users")
}

model Family {
  id          String         @id @default(cuid())
  name        String
  description String?
  inviteCode  String?        @unique
  creatorId   String
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  deletedAt   DateTime?
  activities  Activity[]     @relation("FamilyActivities")
  creator     User           @relation("FamilyCreator", fields: [creatorId], references: [id])
  goals       FamilyGoal[]   @relation("FamilyGoals")
  members     FamilyMember[]
  tasks       Task[]         @relation("FamilyTasks")

  @@map("families")
}

model FamilyMember {
  id                     String                  @id @default(cuid())
  name                   String
  gender                 Gender
  birthDate              DateTime
  height                 Float?
  weight                 Float?
  avatar                 String?
  bmi                    Float?
  ageGroup               AgeGroup?
  familyId               String
  userId                 String?                 @unique
  role                   FamilyMemberRole        @default(MEMBER)
  createdAt              DateTime                @default(now())
  updatedAt              DateTime                @updatedAt
  deletedAt              DateTime?
  achievements           Achievement[]
  memberActivities       Activity[]              @relation("MemberActivities")
  aiAdvices              AIAdvice[]
  aiConversations        AIConversation[]
  allergies              Allergy[]
  auxiliaryTrackings     AuxiliaryTracking[]
  budgets                Budget[]
  memberComments         Comment[]               @relation("MemberComments")
  communityComments      CommunityComment[]
  communityPosts         CommunityPost[]
  dailyNutritionTargets  DailyNutritionTarget[]
  devices                DeviceConnection[]      @relation("MemberDevices")
  dietaryPreference      DietaryPreference?
  createdGoals           FamilyGoal[]            @relation("CreatedGoals")
  family                 Family                  @relation(fields: [familyId], references: [id], onDelete: Cascade)
  user                   User?                   @relation(fields: [userId], references: [id])
  healthAnomalies        HealthAnomaly[]
  healthData             HealthData[]
  healthGoals            HealthGoal[]
  healthReminders        HealthReminder[]
  healthReports          HealthReport[]
  healthScores           HealthScore[]
  inventoryItems         InventoryItem[]         @relation("MemberInventoryItems")
  inventoryUsages        InventoryUsage[]        @relation("MemberInventoryUsages")
  leaderboardEntries     LeaderboardEntry[]
  mealLogs               MealLog[]
  mealPlans              MealPlan[]
  medicalReports         MedicalReport[]
  notificationPreference NotificationPreference? @relation("MemberNotificationPreferences")
  notifications          Notification[]          @relation("MemberNotifications")
  quickTemplates         QuickTemplate[]
  recipeFavorites        RecipeFavorite[]
  recipeRatings          RecipeRating[]
  recipeViews            RecipeView[]
  savingsRecommendations SavingsRecommendation[]
  sharedContents         SharedContent[]
  addedShoppingItems     ShoppingItem[]          @relation("AddedShoppingItems")
  assignedShoppingItems  ShoppingItem[]          @relation("AssignedShoppingItems")
  purchasedShoppingItems ShoppingItem[]          @relation("PurchasedShoppingItems")
  assignedTasks          Task[]                  @relation("AssignedTasks")
  createdTasks           Task[]                  @relation("CreatedTasks")
  trackingStreak         TrackingStreak?
  trendData              TrendData[]
  userPreferences        UserPreference?
  wasteLogs              WasteLog[]              @relation("MemberWasteLogs")
  participatedGoals      FamilyGoal[]            @relation("ParticipatedGoals")

  @@map("family_members")
}

model HealthGoal {
  id             String       @id @default(cuid())
  memberId       String
  goalType       GoalType
  targetWeight   Float?
  currentWeight  Float?
  startWeight    Float?
  targetWeeks    Int?
  startDate      DateTime
  targetDate     DateTime?
  tdee           Int?
  bmr            Int?
  activityFactor Float?
  carbRatio      Float?       @default(0.5)
  proteinRatio   Float?       @default(0.2)
  fatRatio       Float?       @default(0.3)
  status         GoalStatus   @default(ACTIVE)
  progress       Float?       @default(0)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  deletedAt      DateTime?
  member         FamilyMember @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@map("health_goals")
}

model Allergy {
  id           String          @id @default(cuid())
  memberId     String
  allergenType AllergenType
  allergenName String
  severity     AllergySeverity
  description  String?
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt
  deletedAt    DateTime?
  member       FamilyMember    @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@map("allergies")
}

model DietaryPreference {
  id            String       @id @default(cuid())
  memberId      String       @unique
  dietType      DietaryType
  isVegetarian  Boolean      @default(false)
  isVegan       Boolean      @default(false)
  isKeto        Boolean      @default(false)
  isLowCarb     Boolean      @default(false)
  isLowFat      Boolean      @default(false)
  isHighProtein Boolean      @default(false)
  isGlutenFree  Boolean      @default(false)
  isDairyFree   Boolean      @default(false)
  isLowSodium   Boolean      @default(false)
  notes         String?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  deletedAt     DateTime?
  member        FamilyMember @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@map("dietary_preferences")
}

model FamilyInvitation {
  id         String           @id @default(cuid())
  familyId   String
  email      String
  inviteCode String           @unique
  role       FamilyMemberRole @default(MEMBER)
  status     InvitationStatus @default(PENDING)
  expiresAt  DateTime
  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt

  @@map("family_invitations")
}

model Food {
  id                String                   @id @default(cuid())
  name              String
  nameEn            String?
  aliases           String                   @default("[]")
  calories          Float
  protein           Float
  carbs             Float
  fat               Float
  fiber             Float?
  sugar             Float?
  sodium            Float?
  vitaminA          Float?
  vitaminC          Float?
  calcium           Float?
  iron              Float?
  category          FoodCategory
  tags              String                   @default("[]")
  source            DataSource               @default(LOCAL)
  usdaId            String?
  verified          Boolean                  @default(false)
  createdAt         DateTime                 @default(now())
  updatedAt         DateTime                 @updatedAt
  cachedAt          DateTime?
  substituteFoods   IngredientSubstitution[] @relation("SubstituteFoods")
  inventoryItems    InventoryItem[]          @relation("InventoryItems")
  mealIngredients   MealIngredient[]
  mealLogFoods      MealLogFood[]
  platformProducts  PlatformProduct[]        @relation("PlatformProducts")
  priceHistories    PriceHistory[]
  recipeIngredients RecipeIngredient[]       @relation("RecipeIngredients")
  shoppingItems     ShoppingItem[]
  templateFoods     TemplateFood[]

  @@index([category])
  @@index([source])
  @@index([name])
  @@index([nameEn])
  @@index([usdaId])
  @@index([category, name])
  @@index([verified, source])
  @@map("foods")
}

model HealthData {
  id                     String            @id @default(cuid())
  memberId               String
  weight                 Float?
  bodyFat                Float?
  muscleMass             Float?
  bloodPressureSystolic  Int?
  bloodPressureDiastolic Int?
  heartRate              Int?
  measuredAt             DateTime          @default(now())
  source                 HealthDataSource  @default(MANUAL)
  notes                  String?
  deviceConnectionId     String?
  createdAt              DateTime          @default(now())
  updatedAt              DateTime          @updatedAt
  deviceConnection       DeviceConnection? @relation("DeviceHealthData", fields: [deviceConnectionId], references: [id])
  member                 FamilyMember      @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@index([memberId, measuredAt])
  @@index([memberId])
  @@index([deviceConnectionId])
  @@map("health_data")
}

model HealthReminder {
  id              String       @id @default(cuid())
  memberId        String
  reminderType    ReminderType
  enabled         Boolean      @default(true)
  hour            Int
  minute          Int          @default(0)
  daysOfWeek      String       @default("[]")
  message         String?
  lastTriggeredAt DateTime?
  streakDays      Int          @default(0)
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  member          FamilyMember @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@unique([memberId, reminderType])
  @@index([memberId])
  @@map("health_reminders")
}

model MealPlan {
  id             String         @id @default(cuid())
  memberId       String
  startDate      DateTime
  endDate        DateTime
  goalType       GoalType
  targetCalories Float
  targetProtein  Float
  targetCarbs    Float
  targetFat      Float
  status         PlanStatus     @default(ACTIVE)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  deletedAt      DateTime?
  member         FamilyMember   @relation(fields: [memberId], references: [id], onDelete: Cascade)
  meals          Meal[]
  shoppingLists  ShoppingList[]

  @@index([memberId])
  @@index([startDate, endDate])
  @@map("meal_plans")
}

model Meal {
  id          String           @id @default(cuid())
  planId      String
  date        DateTime
  mealType    MealType
  calories    Float
  protein     Float
  carbs       Float
  fat         Float
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  ingredients MealIngredient[]
  plan        MealPlan         @relation(fields: [planId], references: [id], onDelete: Cascade)

  @@index([planId])
  @@index([planId, date, mealType])
  @@map("meals")
}

model MealIngredient {
  id     String @id @default(cuid())
  mealId String
  foodId String
  amount Float
  food   Food   @relation(fields: [foodId], references: [id])
  meal   Meal   @relation(fields: [mealId], references: [id], onDelete: Cascade)

  @@index([mealId])
  @@index([foodId])
  @@map("meal_ingredients")
}

model MedicalReport {
  id          String             @id @default(cuid())
  memberId    String
  fileUrl     String
  fileName    String
  fileSize    Int
  mimeType    String
  ocrStatus   OcrStatus          @default(PENDING)
  ocrText     String?
  ocrError    String?
  reportDate  DateTime?
  institution String?
  reportType  String?
  isCorrected Boolean            @default(false)
  correctedAt DateTime?
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  deletedAt   DateTime?
  indicators  MedicalIndicator[]
  member      FamilyMember       @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@index([memberId])
  @@index([memberId, reportDate])
  @@index([ocrStatus])
  @@map("medical_reports")
}

model MedicalIndicator {
  id             String          @id @default(cuid())
  reportId       String
  indicatorType  IndicatorType
  name           String
  value          Float
  unit           String
  referenceRange String?
  isAbnormal     Boolean         @default(false)
  status         IndicatorStatus @default(NORMAL)
  isCorrected    Boolean         @default(false)
  originalValue  Float?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  report         MedicalReport   @relation(fields: [reportId], references: [id], onDelete: Cascade)

  @@index([reportId])
  @@index([reportId, indicatorType])
  @@map("medical_indicators")
}

model ShoppingListShare {
  id           String       @id @default(cuid())
  listId       String
  token        String       @unique
  expiresAt    DateTime
  createdBy    String
  viewCount    Int          @default(0)
  lastViewedAt DateTime?
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  list         ShoppingList @relation(fields: [listId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([expiresAt])
  @@map("shopping_list_shares")
}

model ShoppingList {
  id            String              @id @default(cuid())
  planId        String
  name          String              @default(cuid())
  budget        Float?
  estimatedCost Float?
  actualCost    Float?
  status        ListStatus          @default(PENDING)
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  items         ShoppingItem[]
  shares        ShoppingListShare[]
  plan          MealPlan            @relation(fields: [planId], references: [id], onDelete: Cascade)

  @@index([planId])
  @@index([status])
  @@map("shopping_lists")
}

model ShoppingItem {
  id                String        @id @default(cuid())
  listId            String
  foodId            String
  amount            Float
  category          FoodCategory
  purchased         Boolean       @default(false)
  estimatedPrice    Float?
  assigneeId        String?
  addedBy           String?
  purchasedBy       String?
  purchasedAt       DateTime?
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  addedByMember     FamilyMember? @relation("AddedShoppingItems", fields: [addedBy], references: [id])
  assignee          FamilyMember? @relation("AssignedShoppingItems", fields: [assigneeId], references: [id])
  food              Food          @relation(fields: [foodId], references: [id])
  list              ShoppingList  @relation(fields: [listId], references: [id], onDelete: Cascade)
  purchasedByMember FamilyMember? @relation("PurchasedShoppingItems", fields: [purchasedBy], references: [id])

  @@index([listId])
  @@index([foodId])
  @@index([category])
  @@index([assigneeId])
  @@index([addedBy])
  @@index([purchasedBy])
  @@map("shopping_items")
}

model MealLog {
  id         String        @id @default(cuid())
  memberId   String
  date       DateTime
  mealType   MealType
  calories   Float
  protein    Float
  carbs      Float
  fat        Float
  fiber      Float?        @default(0)
  sugar      Float?        @default(0)
  sodium     Float?        @default(0)
  notes      String?
  checkedAt  DateTime      @default(now())
  isTemplate Boolean       @default(false)
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt
  deletedAt  DateTime?
  photos     FoodPhoto[]
  foods      MealLogFood[]
  member     FamilyMember  @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@index([memberId, date])
  @@index([memberId, mealType])
  @@map("meal_logs")
}

model MealLogFood {
  id        String   @id @default(cuid())
  mealLogId String
  foodId    String
  amount    Float
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  food      Food     @relation(fields: [foodId], references: [id])
  mealLog   MealLog  @relation(fields: [mealLogId], references: [id], onDelete: Cascade)

  @@index([mealLogId])
  @@index([foodId])
  @@map("meal_log_foods")
}

model FoodPhoto {
  id                String            @id @default(cuid())
  mealLogId         String
  fileUrl           String
  fileName          String
  fileSize          Int
  recognitionStatus RecognitionStatus @default(PENDING)
  recognitionResult String?
  confidence        Float?
  recognitionError  String?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  mealLog           MealLog           @relation(fields: [mealLogId], references: [id], onDelete: Cascade)

  @@index([mealLogId])
  @@index([recognitionStatus])
  @@map("food_photos")
}

model TrackingStreak {
  id            String       @id @default(cuid())
  memberId      String       @unique
  currentStreak Int          @default(0)
  longestStreak Int          @default(0)
  totalDays     Int          @default(0)
  lastCheckIn   DateTime?
  badges        String       @default("[]")
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  member        FamilyMember @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@map("tracking_streaks")
}

model QuickTemplate {
  id          String         @id @default(cuid())
  memberId    String
  name        String
  description String?
  mealType    MealType
  calories    Float
  protein     Float
  carbs       Float
  fat         Float
  useCount    Int            @default(0)
  lastUsed    DateTime?
  score       Float          @default(0)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  deletedAt   DateTime?
  member      FamilyMember   @relation(fields: [memberId], references: [id], onDelete: Cascade)
  foods       TemplateFood[]

  @@index([memberId, mealType])
  @@index([memberId, score])
  @@map("quick_templates")
}

model TemplateFood {
  id         String        @id @default(cuid())
  templateId String
  foodId     String
  amount     Float
  food       Food          @relation(fields: [foodId], references: [id])
  template   QuickTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@index([templateId])
  @@index([foodId])
  @@map("template_foods")
}

model DailyNutritionTarget {
  id                String       @id @default(cuid())
  memberId          String
  date              DateTime     @db.Date
  targetCalories    Float
  targetProtein     Float
  targetCarbs       Float
  targetFat         Float
  actualCalories    Float        @default(0)
  actualProtein     Float        @default(0)
  actualCarbs       Float        @default(0)
  actualFat         Float        @default(0)
  caloriesDeviation Float        @default(0)
  proteinDeviation  Float        @default(0)
  carbsDeviation    Float        @default(0)
  fatDeviation      Float        @default(0)
  isCompleted       Boolean      @default(false)
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt
  member            FamilyMember @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@unique([memberId, date])
  @@index([memberId, date])
  @@map("daily_nutrition_targets")
}

model AuxiliaryTracking {
  id              String       @id @default(cuid())
  memberId        String
  date            DateTime     @db.Date
  waterIntake     Int?         @default(0)
  waterTarget     Int?         @default(2000)
  exerciseMinutes Int?         @default(0)
  caloriesBurned  Int?         @default(0)
  exerciseType    String?
  sleepHours      Float?
  sleepQuality    String?
  weight          Float?
  bodyFat         Float?
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  member          FamilyMember @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@unique([memberId, date])
  @@index([memberId, date])
  @@map("auxiliary_trackings")
}

model HealthReport {
  id             String       @id @default(cuid())
  memberId       String
  reportType     ReportType
  startDate      DateTime
  endDate        DateTime
  title          String
  summary        String?
  dataSnapshot   String
  insights       String?
  overallScore   Float?
  htmlContent    String?
  pdfUrl         String?
  shareToken     String?      @unique
  shareExpiresAt DateTime?
  status         ReportStatus @default(GENERATING)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  deletedAt      DateTime?
  member         FamilyMember @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@index([memberId, reportType])
  @@index([memberId, startDate])
  @@index([shareToken])
  @@map("health_reports")
}

model HealthScore {
  id               String       @id @default(cuid())
  memberId         String
  date             DateTime     @db.Date
  overallScore     Float
  nutritionScore   Float?
  exerciseScore    Float?
  sleepScore       Float?
  medicalScore     Float?
  grade            ScoreGrade
  dataCompleteness Float        @default(0)
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  member           FamilyMember @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@unique([memberId, date])
  @@index([memberId, date])
  @@index([memberId, overallScore])
  @@map("health_scores")
}

model TrendData {
  id             String        @id @default(cuid())
  memberId       String
  dataType       TrendDataType
  startDate      DateTime
  endDate        DateTime
  aggregatedData String
  mean           Float?
  median         Float?
  min            Float?
  max            Float?
  stdDev         Float?
  trendDirection String?
  slope          Float?
  rSquared       Float?
  predictions    String?
  expiresAt      DateTime
  hitCount       Int           @default(0)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  member         FamilyMember  @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@unique([memberId, dataType, startDate, endDate])
  @@index([memberId, dataType])
  @@index([expiresAt])
  @@map("trend_data")
}

model HealthAnomaly {
  id          String          @id @default(cuid())
  memberId    String
  anomalyType AnomalyType
  severity    AnomalySeverity
  title       String
  description String
  detectedAt  DateTime        @default(now())
  dataType    TrendDataType
  value       Float
  expectedMin Float?
  expectedMax Float?
  deviation   Float?
  status      AnomalyStatus   @default(PENDING)
  resolvedAt  DateTime?
  resolution  String?
  notified    Boolean         @default(false)
  notifiedAt  DateTime?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  deletedAt   DateTime?
  member      FamilyMember    @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@index([memberId, anomalyType])
  @@index([memberId, status])
  @@index([detectedAt])
  @@map("health_anomalies")
}

model AIAdvice {
  id          String       @id @default(cuid())
  memberId    String
  type        AIAdviceType
  content     Json
  prompt      String?
  tokens      Int
  feedback    Json?
  generatedAt DateTime     @default(now())
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  deletedAt   DateTime?
  member      FamilyMember @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@index([memberId])
  @@index([type])
  @@index([generatedAt])
  @@map("ai_advice")
}

model AIConversation {
  id            String             @id @default(cuid())
  memberId      String
  title         String?
  messages      Json
  status        ConversationStatus @default(ACTIVE)
  tokens        Int
  lastMessageAt DateTime           @updatedAt
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  deletedAt     DateTime?
  member        FamilyMember       @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@index([memberId])
  @@index([status])
  @@index([lastMessageAt])
  @@map("ai_conversations")
}

model PromptTemplate {
  id         String     @id @default(cuid())
  name       String
  type       PromptType
  template   String
  version    String     @default("1.0")
  parameters Json?
  isActive   Boolean    @default(true)
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt

  @@unique([type, version])
  @@index([type])
  @@index([isActive])
  @@map("prompt_templates")
}

model UserConsent {
  id        String    @id @default(cuid())
  userId    String
  consentId String
  granted   Boolean   @default(false)
  context   Json?
  ipAddress String?
  userAgent String?
  grantedAt DateTime  @default(now())
  expiresAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@unique([userId, consentId])
  @@index([userId])
  @@index([consentId])
  @@index([granted])
  @@index([expiresAt])
  @@map("user_consents")
}

model Budget {
  id                String        @id @default(cuid())
  memberId          String
  name              String
  period            BudgetPeriod
  startDate         DateTime
  endDate           DateTime
  totalAmount       Float
  vegetableBudget   Float?
  meatBudget        Float?
  fruitBudget       Float?
  grainBudget       Float?
  dairyBudget       Float?
  otherBudget       Float?
  status            BudgetStatus  @default(ACTIVE)
  usedAmount        Float         @default(0)
  remainingAmount   Float?
  usagePercentage   Float?
  alertThreshold80  Boolean       @default(true)
  alertThreshold100 Boolean       @default(true)
  alertThreshold110 Boolean       @default(true)
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  deletedAt         DateTime?
  alerts            BudgetAlert[]
  member            FamilyMember  @relation(fields: [memberId], references: [id], onDelete: Cascade)
  spendings         Spending[]

  @@index([memberId])
  @@index([memberId, period])
  @@index([startDate, endDate])
  @@map("budgets")
}

model Spending {
  id            String       @id @default(cuid())
  budgetId      String
  amount        Float
  category      FoodCategory
  description   String
  transactionId String?
  platform      String?
  items         Json?
  purchaseDate  DateTime     @default(now())
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  deletedAt     DateTime?
  budget        Budget       @relation(fields: [budgetId], references: [id], onDelete: Cascade)

  @@index([budgetId])
  @@index([budgetId, category])
  @@index([purchaseDate])
  @@map("spendings")
}

model PriceHistory {
  id         String      @id @default(cuid())
  foodId     String
  price      Float
  unit       String
  unitPrice  Float
  platform   String
  recordedAt DateTime    @default(now())
  source     PriceSource @default(MANUAL)
  isValid    Boolean     @default(true)
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt
  deletedAt  DateTime?
  food       Food        @relation(fields: [foodId], references: [id], onDelete: Cascade)

  @@index([foodId])
  @@index([foodId, platform])
  @@index([recordedAt])
  @@map("price_histories")
}

model SavingsRecommendation {
  id              String               @id @default(cuid())
  memberId        String
  type            SavingsType
  title           String
  description     String
  savings         Float
  originalPrice   Float?
  discountedPrice Float?
  platform        String?
  foodItems       Json?
  validUntil      DateTime?
  status          RecommendationStatus @default(PENDING)
  viewed          Boolean              @default(false)
  acted           Boolean              @default(false)
  feedback        String?
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt
  deletedAt       DateTime?
  member          FamilyMember         @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@index([memberId])
  @@index([memberId, type])
  @@index([status])
  @@index([validUntil])
  @@map("savings_recommendations")
}

model BudgetAlert {
  id             String      @id @default(cuid())
  budgetId       String
  type           AlertType
  threshold      Float
  currentValue   Float
  message        String
  status         AlertStatus @default(ACTIVE)
  acknowledgedAt DateTime?
  resolvedAt     DateTime?
  notified       Boolean     @default(false)
  notifiedAt     DateTime?
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt
  budget         Budget      @relation(fields: [budgetId], references: [id], onDelete: Cascade)

  @@index([budgetId])
  @@index([budgetId, type])
  @@index([status])
  @@map("budget_alerts")
}

model PlatformAccount {
  id                     String                @id @default(cuid())
  userId                 String
  platform               EcommercePlatform
  platformUserId         String?
  username               String?
  accessToken            String?
  refreshToken           String?
  tokenType              String?               @default("Bearer")
  scope                  String?
  expiresAt              DateTime?
  status                 PlatformAccountStatus @default(ACTIVE)
  isActive               Boolean               @default(true)
  lastSyncAt             DateTime?
  syncError              String?
  defaultDeliveryAddress Json?
  preferences            Json?
  createdAt              DateTime              @default(now())
  updatedAt              DateTime              @updatedAt
  deletedAt              DateTime?
  orders                 Order[]
  user                   User                  @relation("PlatformAccounts", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, platform])
  @@index([userId])
  @@index([platform])
  @@index([status])
  @@map("platform_accounts")
}

model Order {
  id                 String            @id @default(cuid())
  userId             String
  accountId          String
  platformOrderId    String            @unique
  platform           EcommercePlatform
  subtotal           Float
  shippingFee        Float             @default(0)
  discount           Float             @default(0)
  totalAmount        Float
  status             OrderStatus       @default(PENDING_PAYMENT)
  paymentStatus      String?
  deliveryStatus     DeliveryStatus?
  orderDate          DateTime          @default(now())
  paymentDate        DateTime?
  shipmentDate       DateTime?
  deliveryDate       DateTime?
  actualDeliveryDate DateTime?
  deliveryAddress    Json
  trackingNumber     String?
  deliveryNotes      String?
  items              Json
  orderSummary       Json?
  platformResponse   Json?
  syncError          String?
  lastSyncAt         DateTime?
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  deletedAt          DateTime?
  account            PlatformAccount   @relation(fields: [accountId], references: [id], onDelete: Cascade)
  user               User              @relation("UserOrders", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([accountId])
  @@index([platform])
  @@index([platformOrderId])
  @@index([status])
  @@index([orderDate])
  @@map("orders")
}

model PlatformProduct {
  id                String            @id @default(cuid())
  platform          EcommercePlatform
  platformProductId String
  sku               String?
  name              String
  description       String?
  brand             String?
  category          String?
  imageUrl          String?
  specification     Json?
  weight            Float?
  volume            Float?
  unit              String?
  price             Float
  originalPrice     Float?
  currency          String            @default("CNY")
  priceUnit         String?
  stock             Int               @default(0)
  isInStock         Boolean           @default(true)
  stockStatus       String?
  salesCount        Int?
  rating            Float?
  reviewCount       Int?
  deliveryOptions   Json?
  deliveryTime      Json?
  shippingFee       Float?
  matchedFoodId     String?
  matchConfidence   Float?
  matchKeywords     Json?
  cachedAt          DateTime          @default(now())
  expiresAt         DateTime
  isValid           Boolean           @default(true)
  platformData      Json?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  deletedAt         DateTime?
  matchedFood       Food?             @relation("PlatformProducts", fields: [matchedFoodId], references: [id])

  @@unique([platform, platformProductId])
  @@index([platform])
  @@index([matchedFoodId])
  @@index([matchConfidence])
  @@index([cachedAt])
  @@index([expiresAt])
  @@map("platform_products")
}

model Recipe {
  id            String              @id @default(cuid())
  name          String
  description   String?
  cuisine       String?
  difficulty    Difficulty          @default(MEDIUM)
  prepTime      Int
  cookTime      Int
  totalTime     Int
  servings      Int
  calories      Float
  protein       Float
  carbs         Float
  fat           Float
  fiber         Float?
  sugar         Float?
  sodium        Float?
  imageUrl      String?
  images        String              @default("[]")
  videoUrl      String?
  category      RecipeCategory
  tags          String              @default("[]")
  mealTypes     String              @default("[]")
  averageRating Float               @default(0)
  ratingCount   Int                 @default(0)
  favoriteCount Int                 @default(0)
  viewCount     Int                 @default(0)
  status        RecipeStatus        @default(DRAFT)
  isPublic      Boolean             @default(true)
  isVerified    Boolean             @default(false)
  seasons       String              @default("[]")
  estimatedCost Float?
  costLevel     CostLevel           @default(MEDIUM)
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  deletedAt     DateTime?
  favorites     RecipeFavorite[]
  ingredients   RecipeIngredient[]
  instructions  RecipeInstruction[]
  ratings       RecipeRating[]
  views         RecipeView[]

  @@index([category])
  @@index([difficulty])
  @@index([status])
  @@index([averageRating])
  @@index([viewCount])
  @@index([createdAt])
  @@map("recipes")
}

model RecipeIngredient {
  id              String                   @id @default(cuid())
  recipeId        String
  foodId          String
  amount          Float
  unit            String
  notes           String?
  optional        Boolean                  @default(false)
  isSubstitutable Boolean                  @default(true)
  substitutions   IngredientSubstitution[] @relation("RecipeIngredientSubstitutions")
  food            Food                     @relation("RecipeIngredients", fields: [foodId], references: [id])
  recipe          Recipe                   @relation(fields: [recipeId], references: [id], onDelete: Cascade)

  @@index([recipeId])
  @@index([foodId])
  @@map("recipe_ingredients")
}

model RecipeInstruction {
  id          String  @id @default(cuid())
  recipeId    String
  stepNumber  Int
  title       String
  content     String
  imageUrl    String?
  videoUrl    String?
  timer       Int?
  temperature Int?
  recipe      Recipe  @relation(fields: [recipeId], references: [id], onDelete: Cascade)

  @@unique([recipeId, stepNumber])
  @@index([recipeId])
  @@map("recipe_instructions")
}

model RecipeRating {
  id       String       @id @default(cuid())
  recipeId String
  memberId String
  rating   Int
  comment  String?
  tags     String       @default("[]")
  ratedAt  DateTime     @default(now())
  isPublic Boolean      @default(true)
  member   FamilyMember @relation(fields: [memberId], references: [id], onDelete: Cascade)
  recipe   Recipe       @relation(fields: [recipeId], references: [id], onDelete: Cascade)

  @@unique([recipeId, memberId])
  @@index([recipeId])
  @@index([memberId])
  @@index([rating])
  @@index([ratedAt])
  @@map("recipe_ratings")
}

model RecipeFavorite {
  id          String       @id @default(cuid())
  recipeId    String
  memberId    String
  favoritedAt DateTime     @default(now())
  notes       String?
  member      FamilyMember @relation(fields: [memberId], references: [id], onDelete: Cascade)
  recipe      Recipe       @relation(fields: [recipeId], references: [id], onDelete: Cascade)

  @@unique([recipeId, memberId])
  @@index([recipeId])
  @@index([memberId])
  @@index([favoritedAt])
  @@map("recipe_favorites")
}

model RecipeView {
  id           String       @id @default(cuid())
  recipeId     String
  memberId     String
  viewedAt     DateTime     @default(now())
  viewDuration Int?
  source       String?
  member       FamilyMember @relation(fields: [memberId], references: [id], onDelete: Cascade)
  recipe       Recipe       @relation(fields: [recipeId], references: [id], onDelete: Cascade)

  @@index([recipeId])
  @@index([memberId])
  @@index([viewedAt])
  @@map("recipe_views")
}

model IngredientSubstitution {
  id                   String           @id @default(cuid())
  originalIngredientId String
  substituteFoodId     String
  substitutionType     SubstitutionType
  reason               String?
  nutritionDelta       Json?
  costDelta            Float?
  tasteSimilarity      Float?
  conditions           String           @default("[]")
  isValid              Boolean          @default(true)
  originalIngredient   RecipeIngredient @relation("RecipeIngredientSubstitutions", fields: [originalIngredientId], references: [id], onDelete: Cascade)
  substituteFood       Food             @relation("SubstituteFoods", fields: [substituteFoodId], references: [id])

  @@index([originalIngredientId])
  @@index([substituteFoodId])
  @@index([substitutionType])
  @@map("ingredient_substitutions")
}

model UserPreference {
  id                    String         @id @default(cuid())
  memberId              String         @unique
  spiceLevel            SpiceLevel     @default(MEDIUM)
  sweetness             SweetnessLevel @default(MEDIUM)
  saltiness             SaltinessLevel @default(MEDIUM)
  preferredCuisines     String         @default("[]")
  avoidedIngredients    String         @default("[]")
  preferredIngredients  String         @default("[]")
  maxCookTime           Int?
  minServings           Int            @default(1)
  maxServings           Int            @default(10)
  costLevel             CostLevel      @default(MEDIUM)
  maxEstimatedCost      Float?
  dietType              DietaryType    @default(OMNIVORE)
  isLowCarb             Boolean        @default(false)
  isLowFat              Boolean        @default(false)
  isHighProtein         Boolean        @default(false)
  isVegetarian          Boolean        @default(false)
  isVegan               Boolean        @default(false)
  isGlutenFree          Boolean        @default(false)
  isDairyFree           Boolean        @default(false)
  enableRecommendations Boolean        @default(true)
  recommendationWeight  Json?
  learnedPreferences    Json?          @default("{}")
  preferenceScore       Float          @default(0)
  lastAnalyzedAt        DateTime?
  createdAt             DateTime       @default(now())
  updatedAt             DateTime       @updatedAt
  member                FamilyMember   @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@index([memberId])
  @@index([dietType])
  @@index([costLevel])
  @@map("user_preferences")
}

model Task {
  id           String        @id @default(cuid())
  familyId     String
  title        String
  description  String?
  category     TaskCategory
  assigneeId   String?
  creatorId    String
  status       TaskStatus    @default(TODO)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  dueDate      DateTime?
  completedAt  DateTime?
  startedAt    DateTime?
  priority     TaskPriority  @default(MEDIUM)
  reminderSent Boolean       @default(false)
  remindedAt   DateTime?
  comments     Comment[]     @relation("TaskComments")
  assignee     FamilyMember? @relation("AssignedTasks", fields: [assigneeId], references: [id])
  creator      FamilyMember  @relation("CreatedTasks", fields: [creatorId], references: [id])
  family       Family        @relation("FamilyTasks", fields: [familyId], references: [id], onDelete: Cascade)

  @@index([familyId])
  @@index([assigneeId])
  @@index([creatorId])
  @@index([status])
  @@index([dueDate])
  @@map("tasks")
}

model Activity {
  id           String        @id @default(cuid())
  familyId     String
  memberId     String?
  activityType ActivityType
  title        String
  description  String?
  metadata     Json?
  createdAt    DateTime      @default(now())
  isPublic     Boolean       @default(true)
  family       Family        @relation("FamilyActivities", fields: [familyId], references: [id], onDelete: Cascade)
  member       FamilyMember? @relation("MemberActivities", fields: [memberId], references: [id])
  comments     Comment[]     @relation("ActivityComments")

  @@index([familyId])
  @@index([memberId])
  @@index([activityType])
  @@index([createdAt])
  @@map("activities")
}

model Comment {
  id         String        @id @default(cuid())
  targetType CommentTarget
  targetId   String
  authorId   String
  content    String
  isDeleted  Boolean       @default(false)
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt
  deletedAt  DateTime?
  activity   Activity      @relation("ActivityComments", fields: [targetId], references: [id], onDelete: Cascade, map: "comments_activity_fkey")
  author     FamilyMember  @relation("MemberComments", fields: [authorId], references: [id], onDelete: Cascade)
  task       Task          @relation("TaskComments", fields: [targetId], references: [id], onDelete: Cascade, map: "comments_task_fkey")

  @@index([targetType, targetId])
  @@index([authorId])
  @@index([createdAt])
  @@map("comments")
}

model FamilyGoal {
  id                String         @id @default(cuid())
  familyId          String
  title             String
  description       String?
  category          GoalCategory
  targetValue       Float
  currentValue      Float          @default(0)
  unit              String?
  status            GoalStatus     @default(ACTIVE)
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  startDate         DateTime
  targetDate        DateTime?
  completedAt       DateTime?
  creatorId         String
  progress          Float          @default(0)
  rewardDescription String?
  rewardAchieved    Boolean        @default(false)
  creator           FamilyMember   @relation("CreatedGoals", fields: [creatorId], references: [id])
  family            Family         @relation("FamilyGoals", fields: [familyId], references: [id], onDelete: Cascade)
  participants      FamilyMember[] @relation("ParticipatedGoals")

  @@index([familyId])
  @@index([creatorId])
  @@index([status])
  @@index([targetDate])
  @@map("family_goals")
}

model SharedContent {
  id              String            @id @default(cuid())
  memberId        String
  contentType     ShareContentType
  title           String
  description     String?
  imageUrl        String?
  metadata        Json?
  shareToken      String            @unique
  shareUrl        String?
  inviteCode      String?
  sharedPlatforms String            @default("[]")
  privacyLevel    SharePrivacyLevel @default(PUBLIC)
  allowComment    Boolean           @default(true)
  allowLike       Boolean           @default(true)
  viewCount       Int               @default(0)
  likeCount       Int               @default(0)
  commentCount    Int               @default(0)
  shareCount      Int               @default(0)
  clickCount      Int               @default(0)
  downloadCount   Int               @default(0)
  conversionCount Int               @default(0)
  status          ShareStatus       @default(ACTIVE)
  expiresAt       DateTime?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  deletedAt       DateTime?
  communityPostId String?           @unique
  communityPost   CommunityPost?    @relation("SharedContentPost")
  shareTracking   ShareTracking[]
  member          FamilyMember      @relation(fields: [memberId], references: [id], onDelete: Cascade)
  achievements    Achievement[]     @relation("AchievementShares")

  @@index([memberId])
  @@index([contentType])
  @@index([shareToken])
  @@index([status])
  @@index([expiresAt])
  @@index([createdAt])
  @@map("shared_contents")
}

model ShareTracking {
  id            String                 @id @default(cuid())
  shareToken    String
  eventType     ShareTrackingEventType
  platform      String?
  userAgent     String?
  ipAddress     String?
  referrer      String?
  metadata      Json?
  occurredAt    DateTime               @default(now())
  sharedContent SharedContent          @relation(fields: [shareToken], references: [shareToken], onDelete: Cascade)

  @@index([shareToken])
  @@index([eventType])
  @@index([occurredAt])
  @@map("share_tracking")
}

model Achievement {
  id             String            @id @default(cuid())
  memberId       String
  type           AchievementType
  title          String
  description    String
  iconUrl        String?
  imageUrl       String?
  rarity         AchievementRarity
  level          Int               @default(1)
  points         Int               @default(0)
  targetValue    Float?
  currentValue   Float?
  progress       Float             @default(0)
  isUnlocked     Boolean           @default(false)
  unlockedAt     DateTime?
  isShared       Boolean           @default(false)
  sharedAt       DateTime?
  rewardType     String?
  rewardValue    String?
  rewardClaimed  Boolean           @default(false)
  metadata       Json?
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  member         FamilyMember      @relation(fields: [memberId], references: [id], onDelete: Cascade)
  sharedContents SharedContent[]   @relation("AchievementShares")

  @@unique([memberId, type, level])
  @@index([memberId])
  @@index([type])
  @@index([rarity])
  @@index([isUnlocked])
  @@index([unlockedAt])
  @@index([points])
  @@map("achievements")
}

model LeaderboardEntry {
  id                String            @id @default(cuid())
  memberId          String
  leaderboardType   LeaderboardType
  period            LeaderboardPeriod
  periodStart       DateTime
  periodEnd         DateTime
  score             Float
  rank              Int
  previousRank      Int?
  rankChange        Int?
  totalParticipants Int               @default(0)
  percentile        Float?
  isAnonymous       Boolean           @default(false)
  showRank          Boolean           @default(true)
  metadata          Json?
  calculatedAt      DateTime          @default(now())
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  member            FamilyMember      @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@unique([memberId, leaderboardType, period, periodStart, periodEnd])
  @@index([leaderboardType])
  @@index([period])
  @@index([rank])
  @@index([score])
  @@index([calculatedAt])
  @@map("leaderboard_entries")
}

model CommunityPost {
  id                 String              @id @default(cuid())
  memberId           String
  type               CommunityPostType
  title              String
  content            String
  images             String              @default("[]")
  tags               String              @default("[]")
  relatedContentType ShareContentType?
  relatedContentId   String?
  status             CommunityPostStatus @default(DRAFT)
  isPinned           Boolean             @default(false)
  isFeatured         Boolean             @default(false)
  viewCount          Int                 @default(0)
  likeCount          Int                 @default(0)
  commentCount       Int                 @default(0)
  shareCount         Int                 @default(0)
  isModerated        Boolean             @default(false)
  moderatedAt        DateTime?
  moderatorId        String?
  moderationResult   Json?
  reportCount        Int                 @default(0)
  isHidden           Boolean             @default(false)
  publishedAt        DateTime?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  deletedAt          DateTime?
  comments           CommunityComment[]
  sharedContent      SharedContent       @relation("SharedContentPost", fields: [id], references: [communityPostId])
  member             FamilyMember        @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@index([memberId])
  @@index([type])
  @@index([status])
  @@index([publishedAt])
  @@index([isPinned])
  @@index([isFeatured])
  @@index([likeCount])
  @@index([createdAt])
  @@map("community_posts")
}

model CommunityComment {
  id          String             @id @default(cuid())
  postId      String
  memberId    String
  content     String
  parentId    String?
  isDeleted   Boolean            @default(false)
  isHidden    Boolean            @default(false)
  reportCount Int                @default(0)
  isModerated Boolean            @default(false)
  moderatedAt DateTime?
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  deletedAt   DateTime?
  member      FamilyMember       @relation(fields: [memberId], references: [id], onDelete: Cascade)
  parent      CommunityComment?  @relation("CommentReplies", fields: [parentId], references: [id])
  replies     CommunityComment[] @relation("CommentReplies")
  post        CommunityPost      @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@index([postId])
  @@index([memberId])
  @@index([parentId])
  @@index([createdAt])
  @@map("community_comments")
}

model Notification {
  id              String               @id @default(cuid())
  memberId        String
  type            NotificationType
  title           String
  content         String
  priority        NotificationPriority @default(MEDIUM)
  channels        String               @default("[\"IN_APP\"]")
  status          NotificationStatus   @default(PENDING)
  sentAt          DateTime?
  readAt          DateTime?
  metadata        Json?
  actionUrl       String?
  actionText      String?
  deliveryResults String?              @default("{}")
  retryCount      Int                  @default(0)
  maxRetries      Int                  @default(3)
  nextRetryAt     DateTime?
  isDeduped       Boolean              @default(false)
  dedupKey        String?
  batchId         String?
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt
  deletedAt       DateTime?
  logs            NotificationLog[]
  member          FamilyMember         @relation("MemberNotifications", fields: [memberId], references: [id], onDelete: Cascade)

  @@index([memberId])
  @@index([type])
  @@index([status])
  @@index([priority])
  @@index([createdAt])
  @@index([readAt])
  @@index([dedupKey])
  @@index([batchId])
  @@map("notifications")
}

model NotificationPreference {
  id                    String       @id @default(cuid())
  memberId              String       @unique
  enableNotifications   Boolean      @default(true)
  globalQuietHoursStart Int?
  globalQuietHoursEnd   Int?
  dailyMaxNotifications Int          @default(50)
  dailyMaxSMS           Int          @default(5)
  dailyMaxEmail         Int          @default(20)
  channelPreferences    String       @default("{}")
  typeSettings          String       @default("{}")
  wechatOpenId          String?
  wechatSubscribed      Boolean      @default(false)
  pushToken             String?
  pushEnabled           Boolean      @default(false)
  emailEnabled          Boolean      @default(true)
  emailUnsubscribedAt   DateTime?
  phoneEnabled          Boolean      @default(true)
  phoneNumber           String?
  enableSmartScheduling Boolean      @default(true)
  enableDeduplication   Boolean      @default(true)
  createdAt             DateTime     @default(now())
  updatedAt             DateTime     @updatedAt
  member                FamilyMember @relation("MemberNotificationPreferences", fields: [memberId], references: [id], onDelete: Cascade)

  @@index([memberId])
  @@map("notification_preferences")
}

model NotificationTemplate {
  id               String               @id @default(cuid())
  type             NotificationType     @unique
  titleTemplate    String
  contentTemplate  String
  channelTemplates String               @default("{}")
  variables        String               @default("[]")
  isActive         Boolean              @default(true)
  version          String               @default("1.0")
  defaultChannels  String               @default("[\"IN_APP\"]")
  defaultPriority  NotificationPriority @default(MEDIUM)
  translations     String               @default("{}")
  description      String?
  category         String?
  usageCount       Int                  @default(0)
  lastUsed         DateTime?
  createdAt        DateTime             @default(now())
  updatedAt        DateTime             @updatedAt

  @@index([type])
  @@index([isActive])
  @@index([category])
  @@map("notification_templates")
}

model NotificationLog {
  id             String              @id @default(cuid())
  notificationId String
  channel        NotificationChannel
  status         NotificationStatus
  sentAt         DateTime?
  deliveredAt    DateTime?
  readAt         DateTime?
  errorCode      String?
  errorMessage   String?
  errorDetails   Json?
  externalId     String?
  trackingData   Json?
  cost           Float?
  currency       String?
  processingTime Int?
  retryCount     Int                 @default(0)
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt
  notification   Notification        @relation(fields: [notificationId], references: [id], onDelete: Cascade)

  @@index([notificationId])
  @@index([channel])
  @@index([status])
  @@index([sentAt])
  @@index([externalId])
  @@map("notification_logs")
}

model InventoryItem {
  id                String           @id @default(cuid())
  memberId          String
  foodId            String
  quantity          Float
  unit              String
  originalQuantity  Float
  purchaseDate      DateTime         @default(now())
  purchasePrice     Float?
  purchaseSource    String?
  expiryDate        DateTime?
  productionDate    DateTime?
  daysToExpiry      Int?
  storageLocation   StorageLocation  @default(PANTRY)
  storageNotes      String?
  status            InventoryStatus  @default(FRESH)
  minStockThreshold Float?
  isLowStock        Boolean          @default(false)
  barcode           String?
  brand             String?
  packageInfo       String?
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  deletedAt         DateTime?
  food              Food             @relation("InventoryItems", fields: [foodId], references: [id])
  member            FamilyMember     @relation("MemberInventoryItems", fields: [memberId], references: [id], onDelete: Cascade)
  usageRecords      InventoryUsage[]
  wasteRecords      WasteLog[]

  @@index([memberId])
  @@index([foodId])
  @@index([memberId, status])
  @@index([expiryDate])
  @@index([storageLocation])
  @@index([barcode])
  @@map("inventory_items")
}

model InventoryUsage {
  id              String        @id @default(cuid())
  inventoryItemId String
  memberId        String
  usedQuantity    Float
  usedAt          DateTime      @default(now())
  usageType       String
  relatedId       String?
  relatedType     String?
  notes           String?
  recipeName      String?
  createdAt       DateTime      @default(now())
  inventoryItem   InventoryItem @relation(fields: [inventoryItemId], references: [id], onDelete: Cascade)
  member          FamilyMember  @relation("MemberInventoryUsages", fields: [memberId], references: [id], onDelete: Cascade)

  @@index([inventoryItemId])
  @@index([memberId])
  @@index([usedAt])
  @@index([usageType])
  @@map("inventory_usages")
}

model WasteLog {
  id              String        @id @default(cuid())
  inventoryItemId String
  memberId        String
  wastedQuantity  Float
  wasteReason     WasteReason
  wastedAt        DateTime      @default(now())
  estimatedCost   Float?
  notes           String?
  preventable     Boolean       @default(true)
  preventionTip   String?
  createdAt       DateTime      @default(now())
  inventoryItem   InventoryItem @relation(fields: [inventoryItemId], references: [id], onDelete: Cascade)
  member          FamilyMember  @relation("MemberWasteLogs", fields: [memberId], references: [id], onDelete: Cascade)

  @@index([inventoryItemId])
  @@index([memberId])
  @@index([wasteReason])
  @@index([wastedAt])
  @@map("waste_logs")
}

model DeviceConnection {
  id                String             @id @default(cuid())
  memberId          String
  deviceId          String             @unique
  deviceType        DeviceType
  deviceName        String
  manufacturer      String
  model             String?
  firmwareVersion   String?
  platform          PlatformType
  accessToken       String?
  refreshToken      String?
  lastSyncAt        DateTime?
  syncStatus        SyncStatus         @default(PENDING)
  syncInterval      Int                @default(1800)
  permissions       DevicePermission[]
  dataTypes         HealthDataType[]
  isActive          Boolean            @default(true)
  isAutoSync        Boolean            @default(true)
  connectionDate    DateTime           @default(now())
  disconnectionDate DateTime?
  lastError         String?
  errorCount        Int                @default(0)
  retryCount        Int                @default(0)
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  member            FamilyMember       @relation("MemberDevices", fields: [memberId], references: [id], onDelete: Cascade)
  healthData        HealthData[]       @relation("DeviceHealthData")

  @@unique([memberId, deviceId])
  @@index([memberId])
  @@index([deviceType])
  @@index([platform])
  @@index([isActive])
  @@index([lastSyncAt])
  @@map("device_connections")
}

enum UserRole {
  USER
  ADMIN
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum AgeGroup {
  CHILD
  TEENAGER
  ADULT
  ELDERLY
}

enum FamilyMemberRole {
  ADMIN
  MEMBER
  GUEST
}

enum GoalType {
  LOSE_WEIGHT
  GAIN_MUSCLE
  MAINTAIN
  IMPROVE_HEALTH
}

enum GoalStatus {
  ACTIVE
  COMPLETED
  PAUSED
  CANCELLED
}

enum AllergenType {
  FOOD
  ENVIRONMENTAL
  MEDICATION
  OTHER
}

enum AllergySeverity {
  MILD
  MODERATE
  SEVERE
  LIFE_THREATENING
}

enum DietaryType {
  OMNIVORE
  VEGETARIAN
  VEGAN
  PESCETARIAN
  KETO
  PALEO
  MEDITERRANEAN
  LOW_FODMAP
  CUSTOM
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  REJECTED
  EXPIRED
}

enum FoodCategory {
  VEGETABLES
  FRUITS
  GRAINS
  PROTEIN
  SEAFOOD
  DAIRY
  OILS
  SNACKS
  BEVERAGES
  OTHER
}

enum DataSource {
  USDA
  LOCAL
  USER_SUBMITTED
}

enum HealthDataSource {
  MANUAL
  WEARABLE
  MEDICAL_REPORT
  APPLE_HEALTHKIT
  HUAWEI_HEALTH
  GOOGLE_FIT
  XIAOMI_HEALTH
  SAMSUNG_HEALTH
  GARMIN_CONNECT
  FITBIT
}

enum ReminderType {
  WEIGHT
  BLOOD_PRESSURE
  HEART_RATE
  GENERAL
}

enum MealType {
  BREAKFAST
  LUNCH
  DINNER
  SNACK
}

enum PlanStatus {
  ACTIVE
  COMPLETED
  CANCELLED
}

enum OcrStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum IndicatorType {
  TOTAL_CHOLESTEROL
  LDL_CHOLESTEROL
  HDL_CHOLESTEROL
  TRIGLYCERIDES
  FASTING_GLUCOSE
  POSTPRANDIAL_GLUCOSE
  GLYCATED_HEMOGLOBIN
  ALT
  AST
  TOTAL_BILIRUBIN
  DIRECT_BILIRUBIN
  ALP
  CREATININE
  UREA_NITROGEN
  URIC_ACID
  WHITE_BLOOD_CELL
  RED_BLOOD_CELL
  HEMOGLOBIN
  PLATELET
  OTHER
}

enum IndicatorStatus {
  NORMAL
  LOW
  HIGH
  CRITICAL
}

enum ListStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
}

enum RecognitionStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum ReportType {
  WEEKLY
  MONTHLY
  QUARTERLY
  CUSTOM
}

enum ReportStatus {
  GENERATING
  COMPLETED
  FAILED
}

enum ScoreGrade {
  EXCELLENT
  GOOD
  FAIR
  POOR
}

enum SpiceLevel {
  NONE
  LOW
  MEDIUM
  HIGH
  EXTREME
}

enum SweetnessLevel {
  NONE
  LOW
  MEDIUM
  HIGH
  EXTREME
}

enum SaltinessLevel {
  LOW
  MEDIUM
  HIGH
  EXTREME
}

enum TrendDataType {
  WEIGHT
  BODY_FAT
  MUSCLE_MASS
  BLOOD_PRESSURE
  HEART_RATE
  CALORIES
  PROTEIN
  CARBS
  FAT
  EXERCISE
  SLEEP
  WATER
  HEALTH_SCORE
}

enum AnomalyType {
  SUDDEN_CHANGE
  NUTRITION_IMBALANCE
  GOAL_DEVIATION
  THRESHOLD_EXCEEDED
  MISSING_DATA
}

enum AnomalySeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum AnomalyStatus {
  PENDING
  ACKNOWLEDGED
  RESOLVED
  IGNORED
}

enum AIAdviceType {
  HEALTH_ANALYSIS
  RECIPE_OPTIMIZATION
  CONSULTATION
  REPORT_GENERATION
}

enum ConversationStatus {
  ACTIVE
  ARCHIVED
}

enum PromptType {
  HEALTH_ANALYSIS
  RECIPE_OPTIMIZATION
  CONSULTATION
  REPORT_GENERATION
}

enum ConsentType {
  AI_HEALTH_ANALYSIS
  MEDICAL_DATA_PROCESSING
  HEALTH_DATA_SHARING
  HEALTH_RESEARCH_PARTICIPATION
}

enum BudgetPeriod {
  WEEKLY
  MONTHLY
  QUARTERLY
  YEARLY
  CUSTOM
}

enum BudgetStatus {
  ACTIVE
  COMPLETED
  CANCELLED
  EXPIRED
}

enum PriceSource {
  MANUAL
  CRAWLER
  API
  USER_REPORT
}

enum SavingsType {
  PROMOTION
  GROUP_BUY
  SEASONAL
  BULK_PURCHASE
  PLATFORM_SWITCH
  SUBSTITUTE
}

enum RecommendationStatus {
  PENDING
  VIEWED
  ACCEPTED
  REJECTED
  EXPIRED
}

enum AlertType {
  WARNING_80
  WARNING_100
  OVER_BUDGET_110
  CATEGORY_OVER
  DAILY_EXCESS
}

enum AlertStatus {
  ACTIVE
  ACKNOWLEDGED
  RESOLVED
  DISMISSED
}

enum EcommercePlatform {
  SAMS_CLUB
  HEMA
  DINGDONG
}

enum PlatformAccountStatus {
  ACTIVE
  INACTIVE
  EXPIRED
  ERROR
}

enum OrderStatus {
  PENDING_PAYMENT
  PAID
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
}

enum DeliveryStatus {
  PREPARING
  READY_FOR_PICKUP
  OUT_FOR_DELIVERY
  DELIVERED
  FAILED
}

enum Difficulty {
  EASY
  MEDIUM
  HARD
}

enum RecipeCategory {
  MAIN_DISH
  SIDE_DISH
  SOUP
  SALAD
  DESSERT
  SNACK
  BREAKFAST
  BEVERAGE
  SAUCE
  OTHER
}

enum RecipeStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
  DELETED
}

enum CostLevel {
  LOW
  MEDIUM
  HIGH
}

enum SubstitutionType {
  ALLERGY
  STOCK_OUT
  BUDGET
  PREFERENCE
  NUTRITION
  SEASONAL
}

enum TaskCategory {
  SHOPPING
  COOKING
  CLEANING
  HEALTH
  EXERCISE
  OTHER
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum ActivityType {
  MEAL_LOG_ADDED
  RECIPE_ADDED
  TASK_CREATED
  TASK_COMPLETED
  SHOPPING_UPDATED
  GOAL_ACHIEVED
  CHECK_IN
  HEALTH_DATA
  OTHER
}

enum CommentTarget {
  TASK
  ACTIVITY
}

enum GoalCategory {
  WEIGHT_LOSS
  EXERCISE
  NUTRITION
  SAVINGS
  CHECK_IN_STREAK
  OTHER
}

enum ShareContentType {
  HEALTH_REPORT
  GOAL_ACHIEVEMENT
  MEAL_LOG
  RECIPE
  ACHIEVEMENT
  CHECK_IN_STREAK
  WEIGHT_MILESTONE
  WEEKLY_SUMMARY
  MONTHLY_REPORT
}

enum SharePlatform {
  WECHAT
  WECHAT_MOMENTS
  WEIBO
  LINK
  COMMUNITY
}

enum ShareStatus {
  ACTIVE
  EXPIRED
  REVOKED
  DELETED
}

enum AchievementType {
  CHECK_IN_STREAK
  WEIGHT_LOSS
  NUTRITION_GOAL
  EXERCISE_TARGET
  HEALTH_MILESTONE
  COMMUNITY_CONTRIBUTION
}

enum AchievementRarity {
  BRONZE
  SILVER
  GOLD
  PLATINUM
  DIAMOND
}

enum LeaderboardType {
  HEALTH_SCORE
  CHECK_IN_STREAK
  WEIGHT_LOSS
  EXERCISE_MINUTES
  NUTRITION_SCORE
}

enum LeaderboardPeriod {
  DAILY
  WEEKLY
  MONTHLY
  YEARLY
  ALL_TIME
}

enum CommunityPostStatus {
  DRAFT
  PUBLISHED
  HIDDEN
  DELETED
}

enum CommunityPostType {
  EXPERIENCE
  RECIPE_SHOW
  ACHIEVEMENT
  QUESTION
  DISCUSSION
}

enum SharePrivacyLevel {
  PUBLIC
  FRIENDS
  PRIVATE
}

enum ShareTrackingEventType {
  VIEW
  CLICK
  SHARE
  CONVERSION
  DOWNLOAD
}

enum NotificationType {
  CHECK_IN_REMINDER
  TASK_NOTIFICATION
  EXPIRY_ALERT
  BUDGET_WARNING
  HEALTH_ALERT
  GOAL_ACHIEVEMENT
  FAMILY_ACTIVITY
  SYSTEM_ANNOUNCEMENT
  MARKETING
  OTHER
}

enum NotificationChannel {
  IN_APP
  EMAIL
  SMS
  WECHAT
  PUSH
}

enum NotificationPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum NotificationStatus {
  PENDING
  SENDING
  SENT
  FAILED
  CANCELLED
}

enum StorageLocation {
  REFRIGERATOR
  FREEZER
  PANTRY
  COUNTER
  CABINET
  OTHER
}

enum InventoryStatus {
  FRESH
  EXPIRING
  EXPIRED
  LOW_STOCK
  OUT_OF_STOCK
}

enum WasteReason {
  EXPIRED
  SPOILED
  OVERSTOCK
  PREFERENCE
  OTHER
}

enum DeviceType {
  SMARTWATCH
  FITNESS_BAND
  SMART_SCALE
  BLOOD_PRESSURE_MONITOR
  GLUCOSE_METER
  SMART_RING
  OTHER
}

enum PlatformType {
  APPLE_HEALTHKIT
  HUAWEI_HEALTH
  GOOGLE_FIT
  XIAOMI_HEALTH
  SAMSUNG_HEALTH
  GARMIN_CONNECT
  FITBIT
  OTHER_PLATFORM
}

enum SyncStatus {
  PENDING
  SYNCING
  SUCCESS
  FAILED
  DISABLED
}

enum DevicePermission {
  READ_STEPS
  READ_HEART_RATE
  READ_CALORIES
  READ_SLEEP
  READ_WEIGHT
  READ_BLOOD_PRESSURE
  READ_DISTANCE
  READ_ACTIVE_MINUTES
  READ_EXERCISE
}

enum HealthDataType {
  STEPS
  HEART_RATE
  CALORIES_BURNED
  SLEEP_DURATION
  SLEEP_QUALITY
  WEIGHT
  BODY_FAT
  MUSCLE_MASS
  BLOOD_PRESSURE
  DISTANCE
  ACTIVE_MINUTES
  EXERCISE_TYPE
  EXERCISE_DURATION
  RESTING_HEART_RATE
  FLOORS_CLIMBED
  STANDING_HOURS
}
