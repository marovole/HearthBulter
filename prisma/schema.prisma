// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql" // 支持 Supabase PostgreSQL
  url      = env("DATABASE_URL")
}

// 用户账户表
model User {
  id            String    @id @default(cuid())
  email         String    @unique
  emailVerified DateTime?
  name          String?
  image         String?
  password      String? // 密码认证用户使用
  role          UserRole  @default(USER)

  // 关联关系
  createdFamilies Family[]       @relation("FamilyCreator")
  familyMembers   FamilyMember[]

  // 审计字段
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@map("users")
}

// 用户角色枚举
enum UserRole {
  USER
  ADMIN
}

// 家庭表
model Family {
  id          String  @id @default(cuid())
  name        String
  description String?
  inviteCode  String? @unique // 家庭邀请码

  // 关联关系
  creatorId String
  creator   User           @relation("FamilyCreator", fields: [creatorId], references: [id])
  members   FamilyMember[]

  // 审计字段
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@map("families")
}

// 家庭成员表
model FamilyMember {
  id        String   @id @default(cuid())
  name      String
  gender    Gender
  birthDate DateTime
  height    Float? // 身高(cm)
  weight    Float? // 体重(kg)
  avatar    String?

  // 健康计算字段
  bmi      Float? // BMI自动计算
  ageGroup AgeGroup? // 年龄段自动计算

  // 关联关系
  familyId String
  family   Family  @relation(fields: [familyId], references: [id], onDelete: Cascade)
  userId   String? @unique // 可关联到系统用户账户
  user     User?   @relation(fields: [userId], references: [id])

  // 权限
  role FamilyMemberRole @default(MEMBER)

  // 健康目标和过敏史
  healthGoals       HealthGoal[]
  allergies         Allergy[]
  dietaryPreference DietaryPreference?
  healthData        HealthData[]
  healthReminders   HealthReminder[]
  mealPlans         MealPlan[]
  medicalReports    MedicalReport[]
  
  // 营养打卡关联
  mealLogs              MealLog[]
  trackingStreak        TrackingStreak?
  quickTemplates        QuickTemplate[]
  dailyNutritionTargets DailyNutritionTarget[]
  auxiliaryTrackings    AuxiliaryTracking[]
  
  // 健康分析关联
  healthReports HealthReport[]
  healthScores  HealthScore[]
  trendData     TrendData[]
  healthAnomalies HealthAnomaly[]

  // AI 关联
  aiAdvices       AIAdvice[]
  aiConversations AIConversation[]

  // 审计字段
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@map("family_members")
}

// 性别枚举
enum Gender {
  MALE
  FEMALE
  OTHER
}

// 年龄段枚举
enum AgeGroup {
  CHILD // <12岁
  TEENAGER // 12-18岁
  ADULT // 18-65岁
  ELDERLY // >65岁
}

// 家庭成员角色枚举
enum FamilyMemberRole {
  ADMIN // 管理员
  MEMBER // 普通成员
}

// 健康目标表
model HealthGoal {
  id       String       @id @default(cuid())
  memberId String
  member   FamilyMember @relation(fields: [memberId], references: [id], onDelete: Cascade)

  // 目标类型
  goalType GoalType

  // 体重相关目标
  targetWeight  Float? // 目标体重(kg)
  currentWeight Float? // 当前体重(kg)
  startWeight   Float? // 开始体重(kg)

  // 时间设定
  targetWeeks Int? // 目标周期(周)
  startDate   DateTime // 开始日期
  targetDate  DateTime? // 目标日期

  // 计算参数
  tdee           Int? // 每日总能量消耗
  bmr            Int? // 基础代谢率
  activityFactor Float? // 活动系数

  // 宏量营养素分配比例
  carbRatio    Float? @default(0.5) // 碳水化合物比例
  proteinRatio Float? @default(0.2) // 蛋白质比例
  fatRatio     Float? @default(0.3) // 脂肪比例

  // 目标状态
  status   GoalStatus @default(ACTIVE)
  progress Float?     @default(0) // 进度百分比

  // 审计字段
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@map("health_goals")
}

// 目标类型枚举
enum GoalType {
  LOSE_WEIGHT // 减重
  GAIN_MUSCLE // 增肌
  MAINTAIN // 维持体重
  IMPROVE_HEALTH // 改善健康指标
}

// 目标状态枚举
enum GoalStatus {
  ACTIVE // 活跃中
  COMPLETED // 已完成
  PAUSED // 暂停
  CANCELLED // 取消
}

// 过敏史表
model Allergy {
  id       String       @id @default(cuid())
  memberId String
  member   FamilyMember @relation(fields: [memberId], references: [id], onDelete: Cascade)

  // 过敏信息
  allergenType AllergenType
  allergenName String // 具体过敏原名称
  severity     AllergySeverity // 严重程度
  description  String? // 描述

  // 审计字段
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@map("allergies")
}

// 过敏类型枚举
enum AllergenType {
  FOOD // 食物过敏
  ENVIRONMENTAL // 环境过敏
  MEDICATION // 药物过敏
  OTHER // 其他
}

// 过敏严重程度枚举
enum AllergySeverity {
  MILD // 轻微
  MODERATE // 中等
  SEVERE // 严重
  LIFE_THREATENING // 危及生命
}

// 饮食偏好表（扩展功能）
model DietaryPreference {
  id       String       @id @default(cuid())
  memberId String       @unique
  member   FamilyMember @relation(fields: [memberId], references: [id], onDelete: Cascade)

  // 饮食类型
  dietType DietaryType

  // 具体偏好设置
  isVegetarian  Boolean @default(false)
  isVegan       Boolean @default(false)
  isKeto        Boolean @default(false)
  isLowCarb     Boolean @default(false)
  isLowFat      Boolean @default(false)
  isHighProtein Boolean @default(false)
  isGlutenFree  Boolean @default(false)
  isDairyFree   Boolean @default(false)
  isLowSodium   Boolean @default(false)

  // 自定义备注
  notes String?

  // 审计字段
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@map("dietary_preferences")
}

// 饮食类型枚举
enum DietaryType {
  OMNIVORE // 杂食
  VEGETARIAN // 素食
  VEGAN // 严格素食
  PESCETARIAN // 鱼素
  KETO // 生酮饮食
  PALEO // 原始饮食
  MEDITERRANEAN // 地中海饮食
  LOW_FODMAP // 低FODMAP饮食
  CUSTOM // 自定义
}

// 邀请记录表
model FamilyInvitation {
  id         String           @id @default(cuid())
  familyId   String
  email      String
  inviteCode String           @unique
  role       FamilyMemberRole @default(MEMBER)

  // 邀请状态
  status InvitationStatus @default(PENDING)

  // 时间限制
  expiresAt DateTime

  // 审计字段
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("family_invitations")
}

// 邀请状态枚举
enum InvitationStatus {
  PENDING // 待处理
  ACCEPTED // 已接受
  REJECTED // 已拒绝
  EXPIRED // 已过期
}

// 食物表
model Food {
  id      String  @id @default(cuid())
  name    String // 中文名
  nameEn  String? // 英文名（用于USDA查询）
  aliases String  @default("[]") // JSON字符串存储别名数组 ["西红柿", "蕃茄"]

  // 营养成分（per 100g）
  calories Float // kcal
  protein  Float // g
  carbs    Float // g
  fat      Float // g
  fiber    Float? // g
  sugar    Float? // g
  sodium   Float? // mg

  // 微量营养素（可选）
  vitaminA Float? // μg
  vitaminC Float? // mg
  calcium  Float? // mg
  iron     Float? // mg

  // 元数据
  category FoodCategory
  tags     String       @default("[]") // JSON字符串存储标签数组 ["高蛋白", "低碳水"]
  source   DataSource   @default(LOCAL)
  usdaId   String? // USDA FDC ID
  verified Boolean      @default(false)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  cachedAt  DateTime? // USDA数据缓存时间

  // 关联关系
  mealIngredients MealIngredient[]
  shoppingItems   ShoppingItem[]
  mealLogFoods    MealLogFood[]
  templateFoods   TemplateFood[]

  @@index([category])
  @@index([source])
  @@index([nameEn])
  @@map("foods")
}

// 食物分类枚举
enum FoodCategory {
  VEGETABLES // 蔬菜
  FRUITS // 水果
  GRAINS // 谷物
  PROTEIN // 肉蛋奶
  SEAFOOD // 海鲜
  DAIRY // 乳制品
  OILS // 油脂
  SNACKS // 零食
  BEVERAGES // 饮料
  OTHER // 其他
}

// 数据来源枚举
enum DataSource {
  USDA // USDA FoodData Central
  LOCAL // 本地自定义
  USER_SUBMITTED // 用户提交（待审核）
}

// 健康数据表
model HealthData {
  id       String       @id @default(cuid())
  memberId String
  member   FamilyMember @relation(fields: [memberId], references: [id], onDelete: Cascade)

  // 健康指标
  weight                 Float? // kg
  bodyFat                Float? // %
  muscleMass             Float? // kg
  bloodPressureSystolic  Int? // 收缩压 mmHg
  bloodPressureDiastolic Int? // 舒张压 mmHg
  heartRate              Int? // bpm

  // 元数据
  measuredAt DateTime         @default(now())
  source     HealthDataSource @default(MANUAL)
  notes      String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([memberId, measuredAt])
  @@index([memberId])
  @@map("health_data")
}

// 健康数据来源枚举
enum HealthDataSource {
  MANUAL // 手动录入
  WEARABLE // 可穿戴设备
  MEDICAL_REPORT // 体检报告
}

// 健康数据提醒配置表
model HealthReminder {
  id       String       @id @default(cuid())
  memberId String
  member   FamilyMember @relation(fields: [memberId], references: [id], onDelete: Cascade)

  // 提醒类型
  reminderType ReminderType
  enabled      Boolean      @default(true)

  // 提醒时间设置
  hour       Int // 小时 (0-23)
  minute     Int    @default(0) // 分钟 (0-59)
  daysOfWeek String @default("[]") // JSON数组，例如 [1,2,3,4,5] 表示周一到周五

  // 提醒内容
  message String? // 自定义提醒消息

  // 统计信息
  lastTriggeredAt DateTime? // 上次触发时间
  streakDays      Int       @default(0) // 连续打卡天数

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([memberId, reminderType])
  @@index([memberId])
  @@map("health_reminders")
}

// 提醒类型枚举
enum ReminderType {
  WEIGHT // 体重记录提醒
  BLOOD_PRESSURE // 血压记录提醒
  HEART_RATE // 心率记录提醒
  GENERAL // 通用健康数据记录提醒
}

// 食谱计划表
model MealPlan {
  id       String       @id @default(cuid())
  memberId String
  member   FamilyMember @relation(fields: [memberId], references: [id], onDelete: Cascade)

  // 时间范围
  startDate DateTime
  endDate   DateTime

  // 目标类型（参考HealthGoal的goalType）
  goalType GoalType

  // 营养目标（每日目标）
  targetCalories Float
  targetProtein  Float
  targetCarbs    Float
  targetFat      Float

  // 计划状态
  status PlanStatus @default(ACTIVE)

  // 关联关系
  meals         Meal[]
  shoppingLists ShoppingList[]

  // 审计字段
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@index([memberId])
  @@index([startDate, endDate])
  @@map("meal_plans")
}

// 餐食表
model Meal {
  id     String   @id @default(cuid())
  planId String
  plan   MealPlan @relation(fields: [planId], references: [id], onDelete: Cascade)

  // 餐食信息
  date     DateTime
  mealType MealType // BREAKFAST, LUNCH, DINNER, SNACK

  // 营养成分（实际值，从食材计算得出）
  calories Float
  protein  Float
  carbs    Float
  fat      Float

  // 关联关系
  ingredients MealIngredient[]

  // 审计字段
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([planId])
  @@index([planId, date, mealType])
  @@map("meals")
}

// 餐食食材表
model MealIngredient {
  id     String @id @default(cuid())
  mealId String
  meal   Meal   @relation(fields: [mealId], references: [id], onDelete: Cascade)
  foodId String
  food   Food   @relation(fields: [foodId], references: [id])

  // 食材数量
  amount Float // 重量（单位：g）

  @@index([mealId])
  @@index([foodId])
  @@map("meal_ingredients")
}

// 餐食类型枚举
enum MealType {
  BREAKFAST // 早餐
  LUNCH // 午餐
  DINNER // 晚餐
  SNACK // 加餐
}

// 食谱计划状态枚举
enum PlanStatus {
  ACTIVE // 进行中
  COMPLETED // 已完成
  CANCELLED // 已取消
}

// 体检报告表
model MedicalReport {
  id       String       @id @default(cuid())
  memberId String
  member   FamilyMember @relation(fields: [memberId], references: [id], onDelete: Cascade)

  // 文件信息
  fileUrl  String // 文件存储URL（Vercel Blob或S3）
  fileName String // 原始文件名
  fileSize Int // 文件大小（字节）
  mimeType String // 文件MIME类型（application/pdf, image/jpeg等）

  // OCR处理状态
  ocrStatus OcrStatus @default(PENDING)
  ocrText   String? // OCR识别的原始文本
  ocrError  String? // OCR处理错误信息

  // 报告元数据
  reportDate  DateTime? // 报告日期（从报告内容提取）
  institution String? // 医疗机构名称
  reportType  String? // 报告类型（如"体检报告"、"血常规"等）

  // 是否已修正
  isCorrected Boolean   @default(false)
  correctedAt DateTime?

  // 关联关系
  indicators MedicalIndicator[]

  // 审计字段
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@index([memberId])
  @@index([memberId, reportDate])
  @@index([ocrStatus])
  @@map("medical_reports")
}

// OCR处理状态枚举
enum OcrStatus {
  PENDING // 待处理
  PROCESSING // 处理中
  COMPLETED // 已完成
  FAILED // 处理失败
}

// 体检指标表
model MedicalIndicator {
  id       String        @id @default(cuid())
  reportId String
  report   MedicalReport @relation(fields: [reportId], references: [id], onDelete: Cascade)

  // 指标信息
  indicatorType  IndicatorType // 指标类型
  name           String // 指标名称（如"总胆固醇"、"血糖"）
  value          Float // 指标数值
  unit           String // 单位（如"mmol/L"、"U/L"等）
  referenceRange String? // 参考范围（如"<5.2"）

  // 状态判断
  isAbnormal Boolean         @default(false) // 是否异常
  status     IndicatorStatus @default(NORMAL) // 指标状态

  // 是否手动修正
  isCorrected   Boolean @default(false)
  originalValue Float? // 原始OCR识别的值（修正前）

  // 审计字段
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([reportId])
  @@index([reportId, indicatorType])
  @@map("medical_indicators")
}

// 指标类型枚举
enum IndicatorType {
  // 血脂相关
  TOTAL_CHOLESTEROL // 总胆固醇
  LDL_CHOLESTEROL // 低密度脂蛋白胆固醇
  HDL_CHOLESTEROL // 高密度脂蛋白胆固醇
  TRIGLYCERIDES // 甘油三酯

  // 血糖相关
  FASTING_GLUCOSE // 空腹血糖
  POSTPRANDIAL_GLUCOSE // 餐后血糖
  GLYCATED_HEMOGLOBIN // 糖化血红蛋白

  // 肝功能相关
  ALT // 丙氨酸氨基转移酶
  AST // 天门冬氨酸氨基转移酶
  TOTAL_BILIRUBIN // 总胆红素
  DIRECT_BILIRUBIN // 直接胆红素
  ALP // 碱性磷酸酶

  // 肾功能相关
  CREATININE // 肌酐
  UREA_NITROGEN // 尿素氮
  URIC_ACID // 尿酸

  // 其他
  WHITE_BLOOD_CELL // 白细胞
  RED_BLOOD_CELL // 红细胞
  HEMOGLOBIN // 血红蛋白
  PLATELET // 血小板
  OTHER // 其他指标
}

// 指标状态枚举
enum IndicatorStatus {
  NORMAL // 正常
  LOW // 偏低
  HIGH // 偏高
  CRITICAL // 严重异常
}

// 购物清单表
model ShoppingList {
  id     String   @id @default(cuid())
  planId String
  plan   MealPlan @relation(fields: [planId], references: [id], onDelete: Cascade)

  // 预算信息
  budget        Float? // 预算（元）
  estimatedCost Float? // 估算成本
  actualCost    Float? // 实际花费

  // 清单状态
  status ListStatus @default(PENDING)

  // 关联关系
  items ShoppingItem[]

  // 审计字段
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([planId])
  @@index([status])
  @@map("shopping_lists")
}

// 购物清单项表
model ShoppingItem {
  id     String       @id @default(cuid())
  listId String
  list   ShoppingList @relation(fields: [listId], references: [id], onDelete: Cascade)
  foodId String
  food   Food         @relation(fields: [foodId], references: [id])

  // 食材信息
  amount   Float // 重量（单位：g）
  category FoodCategory // 食材分类（冗余字段，便于查询）

  // 采购状态
  purchased      Boolean @default(false)
  estimatedPrice Float? // 估算价格（元）

  // 审计字段
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([listId])
  @@index([foodId])
  @@index([category])
  @@map("shopping_items")
}

// 购物清单状态枚举
enum ListStatus {
  PENDING // 待采购
  IN_PROGRESS // 采购中
  COMPLETED // 已完成
}

// ==================== 营养摄入打卡系统 ====================

// 餐饮记录表（打卡记录）
model MealLog {
  id       String       @id @default(cuid())
  memberId String
  member   FamilyMember @relation(fields: [memberId], references: [id], onDelete: Cascade)

  // 餐食信息
  date     DateTime // 打卡日期
  mealType MealType // BREAKFAST, LUNCH, DINNER, SNACK
  
  // 营养成分（计算得出）
  calories Float
  protein  Float
  carbs    Float
  fat      Float
  fiber    Float? @default(0)
  sugar    Float? @default(0)
  sodium   Float? @default(0)

  // 关联关系
  foods  MealLogFood[] // 记录的食物
  photos FoodPhoto[] // 食物照片

  // 打卡元数据
  notes      String? // 备注
  checkedAt  DateTime @default(now()) // 打卡时间
  isTemplate Boolean  @default(false) // 是否来自模板

  // 审计字段
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@index([memberId, date])
  @@index([memberId, mealType])
  @@map("meal_logs")
}

// 餐饮记录食物关联表
model MealLogFood {
  id        String  @id @default(cuid())
  mealLogId String
  mealLog   MealLog @relation(fields: [mealLogId], references: [id], onDelete: Cascade)
  foodId    String
  food      Food    @relation(fields: [foodId], references: [id])

  // 食物数量
  amount Float // 重量（单位：g）

  // 审计字段
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([mealLogId])
  @@index([foodId])
  @@map("meal_log_foods")
}

// 食物照片表
model FoodPhoto {
  id        String  @id @default(cuid())
  mealLogId String
  mealLog   MealLog @relation(fields: [mealLogId], references: [id], onDelete: Cascade)

  // 文件信息
  fileUrl  String // 文件存储URL（Vercel Blob）
  fileName String // 原始文件名
  fileSize Int // 文件大小（字节）

  // AI识别信息
  recognitionStatus RecognitionStatus @default(PENDING)
  recognitionResult String? // JSON格式的识别结果
  confidence        Float? // 识别置信度（0-1）
  recognitionError  String? // 识别错误信息

  // 审计字段
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([mealLogId])
  @@index([recognitionStatus])
  @@map("food_photos")
}

// 食物识别状态枚举
enum RecognitionStatus {
  PENDING // 待识别
  PROCESSING // 识别中
  COMPLETED // 已完成
  FAILED // 识别失败
}

// 连续打卡记录表
model TrackingStreak {
  id       String       @id @default(cuid())
  memberId String       @unique
  member   FamilyMember @relation(fields: [memberId], references: [id], onDelete: Cascade)

  // 连续打卡统计
  currentStreak Int      @default(0) // 当前连续天数
  longestStreak Int      @default(0) // 最长连续天数
  totalDays     Int      @default(0) // 总打卡天数
  lastCheckIn   DateTime? // 最后打卡日期

  // 徽章记录（JSON数组）
  badges String @default("[]") // ["7-days", "30-days", "100-days"]

  // 审计字段
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("tracking_streaks")
}

// 快速模板表
model QuickTemplate {
  id       String       @id @default(cuid())
  memberId String
  member   FamilyMember @relation(fields: [memberId], references: [id], onDelete: Cascade)

  // 模板信息
  name        String // 模板名称（如"工作日标准早餐"）
  description String? // 描述
  mealType    MealType // 适用餐食类型
  
  // 营养成分（预计算）
  calories Float
  protein  Float
  carbs    Float
  fat      Float

  // 关联关系
  foods TemplateFood[] // 模板食物

  // 使用统计
  useCount  Int       @default(0) // 使用次数
  lastUsed  DateTime? // 最后使用时间
  
  // 智能推荐权重（基于使用频率和时间）
  score     Float @default(0) // 推荐分数

  // 审计字段
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@index([memberId, mealType])
  @@index([memberId, score])
  @@map("quick_templates")
}

// 模板食物关联表
model TemplateFood {
  id         String        @id @default(cuid())
  templateId String
  template   QuickTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  foodId     String
  food       Food          @relation(fields: [foodId], references: [id])

  // 食物数量
  amount Float // 重量（单位：g）

  @@index([templateId])
  @@index([foodId])
  @@map("template_foods")
}

// 营养目标打卡记录表（每日营养目标追踪）
model DailyNutritionTarget {
  id       String       @id @default(cuid())
  memberId String
  member   FamilyMember @relation(fields: [memberId], references: [id], onDelete: Cascade)

  // 日期
  date DateTime @db.Date

  // 每日目标（从HealthGoal计算得出）
  targetCalories Float
  targetProtein  Float
  targetCarbs    Float
  targetFat      Float

  // 实际摄入（从MealLog聚合计算）
  actualCalories Float @default(0)
  actualProtein  Float @default(0)
  actualCarbs    Float @default(0)
  actualFat      Float @default(0)

  // 偏差分析
  caloriesDeviation Float @default(0) // 百分比
  proteinDeviation  Float @default(0)
  carbsDeviation    Float @default(0)
  fatDeviation      Float @default(0)

  // 完成状态
  isCompleted Boolean @default(false) // 是否完成打卡
  
  // 审计字段
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([memberId, date])
  @@index([memberId, date])
  @@map("daily_nutrition_targets")
}

// 辅助打卡表（饮水、运动、睡眠、体重）
model AuxiliaryTracking {
  id       String       @id @default(cuid())
  memberId String
  member   FamilyMember @relation(fields: [memberId], references: [id], onDelete: Cascade)

  // 日期
  date DateTime @db.Date

  // 饮水打卡（ml）
  waterIntake Int? @default(0)
  waterTarget Int? @default(2000) // 默认2000ml

  // 运动打卡
  exerciseMinutes   Int? @default(0) // 运动时长（分钟）
  caloriesBurned    Int? @default(0) // 消耗卡路里
  exerciseType      String? // 运动类型（JSON数组）

  // 睡眠打卡
  sleepHours   Float? // 睡眠时长（小时）
  sleepQuality String? // 睡眠质量（EXCELLENT, GOOD, FAIR, POOR）

  // 体重打卡
  weight    Float? // 体重（kg）
  bodyFat   Float? // 体脂率（%）
  
  // 审计字段
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([memberId, date])
  @@index([memberId, date])
  @@map("auxiliary_trackings")
}

// ==================== 健康分析与报告系统 ====================

// 健康报告表
model HealthReport {
  id       String       @id @default(cuid())
  memberId String
  member   FamilyMember @relation(fields: [memberId], references: [id], onDelete: Cascade)

  // 报告类型
  reportType ReportType // WEEKLY, MONTHLY, QUARTERLY
  
  // 报告时间范围
  startDate DateTime
  endDate   DateTime
  
  // 报告标题和内容
  title   String
  summary String? // 概要
  
  // 报告数据（JSON格式）
  dataSnapshot String // JSON字符串，包含所有统计数据
  insights     String? // AI生成的洞察（JSON数组）
  
  // 健康评分
  overallScore Float? // 综合健康评分（0-100）
  
  // 报告文件
  htmlContent String? @db.Text // HTML格式报告
  pdfUrl      String? // PDF文件URL
  
  // 分享信息
  shareToken String?   @unique // 分享链接token
  shareExpiresAt DateTime? // 分享链接过期时间
  
  // 生成状态
  status ReportStatus @default(GENERATING)
  
  // 审计字段
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@index([memberId, reportType])
  @@index([memberId, startDate])
  @@index([shareToken])
  @@map("health_reports")
}

// 报告类型枚举
enum ReportType {
  WEEKLY // 周报
  MONTHLY // 月报
  QUARTERLY // 季报
  CUSTOM // 自定义
}

// 报告状态枚举
enum ReportStatus {
  GENERATING // 生成中
  COMPLETED // 已完成
  FAILED // 生成失败
}

// 健康评分历史表
model HealthScore {
  id       String       @id @default(cuid())
  memberId String
  member   FamilyMember @relation(fields: [memberId], references: [id], onDelete: Cascade)

  // 评分日期
  date DateTime @db.Date
  
  // 综合评分
  overallScore Float // 0-100分
  
  // 分项评分（按权重计算）
  nutritionScore Float? // 营养评分（权重40%）
  exerciseScore  Float? // 运动评分（权重30%）
  sleepScore     Float? // 睡眠评分（权重20%）
  medicalScore   Float? // 体检评分（权重10%）
  
  // 评分等级
  grade ScoreGrade // EXCELLENT, GOOD, FAIR, POOR
  
  // 数据完整度（用于评分可信度）
  dataCompleteness Float @default(0) // 0-1
  
  // 审计字段
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([memberId, date])
  @@index([memberId, date])
  @@index([memberId, overallScore])
  @@map("health_scores")
}

// 评分等级枚举
enum ScoreGrade {
  EXCELLENT // 优秀 (>=90)
  GOOD // 良好 (>=75)
  FAIR // 一般 (>=60)
  POOR // 较差 (<60)
}

// 趋势数据缓存表
model TrendData {
  id       String       @id @default(cuid())
  memberId String
  member   FamilyMember @relation(fields: [memberId], references: [id], onDelete: Cascade)

  // 数据类型
  dataType TrendDataType
  
  // 时间范围
  startDate DateTime
  endDate   DateTime
  
  // 聚合数据（JSON格式）
  aggregatedData String @db.Text // JSON字符串，包含时序数据点
  
  // 统计数据
  mean     Float? // 平均值
  median   Float? // 中位数
  min      Float? // 最小值
  max      Float? // 最大值
  stdDev   Float? // 标准差
  
  // 趋势分析
  trendDirection String? // UP, DOWN, STABLE
  slope          Float? // 线性回归斜率
  rSquared       Float? // R²值（拟合度）
  
  // 预测数据（JSON格式）
  predictions String? // 未来7天预测值
  
  // 缓存元数据
  expiresAt DateTime // 缓存过期时间
  hitCount  Int      @default(0) // 缓存命中次数
  
  // 审计字段
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([memberId, dataType, startDate, endDate])
  @@index([memberId, dataType])
  @@index([expiresAt])
  @@map("trend_data")
}

// 趋势数据类型枚举
enum TrendDataType {
  WEIGHT // 体重
  BODY_FAT // 体脂率
  MUSCLE_MASS // 肌肉量
  BLOOD_PRESSURE // 血压
  HEART_RATE // 心率
  CALORIES // 卡路里摄入
  PROTEIN // 蛋白质摄入
  CARBS // 碳水化合物摄入
  FAT // 脂肪摄入
  EXERCISE // 运动时长
  SLEEP // 睡眠时长
  WATER // 饮水量
  HEALTH_SCORE // 健康评分
}

// 异常检测记录表
model HealthAnomaly {
  id       String       @id @default(cuid())
  memberId String
  member   FamilyMember @relation(fields: [memberId], references: [id], onDelete: Cascade)

  // 异常信息
  anomalyType  AnomalyType
  severity     AnomalySeverity
  title        String // 异常标题
  description  String // 异常描述
  
  // 检测数据
  detectedAt   DateTime @default(now())
  dataType     TrendDataType
  value        Float // 异常值
  expectedMin  Float? // 预期最小值
  expectedMax  Float? // 预期最大值
  deviation    Float? // 偏差程度（标准差倍数）
  
  // 处理状态
  status     AnomalyStatus @default(PENDING)
  resolvedAt DateTime?
  resolution String? // 处理说明
  
  // 是否已通知
  notified   Boolean @default(false)
  notifiedAt DateTime?
  
  // 审计字段
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@index([memberId, anomalyType])
  @@index([memberId, status])
  @@index([detectedAt])
  @@map("health_anomalies")
}

// 异常类型枚举
enum AnomalyType {
  SUDDEN_CHANGE // 突然变化
  NUTRITION_IMBALANCE // 营养失衡
  GOAL_DEVIATION // 目标偏离
  THRESHOLD_EXCEEDED // 超出阈值
  MISSING_DATA // 数据缺失
}

// 异常严重程度枚举
enum AnomalySeverity {
  LOW // 轻微
  MEDIUM // 中等
  HIGH // 严重
  CRITICAL // 危急
}

// 异常状态枚举
enum AnomalyStatus {
  PENDING // 待处理
  ACKNOWLEDGED // 已确认
  RESOLVED // 已解决
  IGNORED // 已忽略
}

// AI Nutrition Advisor Models

enum AIAdviceType {
  HEALTH_ANALYSIS
  RECIPE_OPTIMIZATION
  CONSULTATION
  REPORT_GENERATION
}

model AIAdvice {
  id          String         @id @default(cuid())
  memberId    String
  member      FamilyMember   @relation(fields: [memberId], references: [id], onDelete: Cascade)
  type        AIAdviceType
  content     Json           // Structured AI response
  prompt      String?        // The prompt sent to AI
  tokens      Int            // Tokens used for cost tracking
  feedback    Json?          // User feedback { rating: number, comment: string }
  generatedAt DateTime       @default(now())

  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  deletedAt   DateTime?

  @@map("ai_advice")
  @@index([memberId])
  @@index([type])
  @@index([generatedAt])
}

enum ConversationStatus {
  ACTIVE
  ARCHIVED
}

model AIConversation {
  id            String            @id @default(cuid())
  memberId      String
  member        FamilyMember      @relation(fields: [memberId], references: [id], onDelete: Cascade)
  title         String?
  messages      Json              // Array of { role: 'user'|'assistant', content: string }
  status        ConversationStatus @default(ACTIVE)
  tokens        Int               // Total tokens for the conversation
  lastMessageAt DateTime          @updatedAt

  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  deletedAt     DateTime?

  @@map("ai_conversations")
  @@index([memberId])
  @@index([status])
  @@index([lastMessageAt])
}

enum PromptType {
  HEALTH_ANALYSIS
  RECIPE_OPTIMIZATION
  CONSULTATION
  REPORT_GENERATION
}

model PromptTemplate {
  id          String     @id @default(cuid())
  name        String
  type        PromptType
  template    String     @db.Text
  version     String     @default("1.0")
  parameters  Json?      // Placeholder parameters e.g. { "user_age": 30 }
  isActive    Boolean    @default(true)

  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@unique([type, version])
  @@map("prompt_templates")
  @@index([type])
  @@index([isActive])
}

// 用户同意类型枚举
enum ConsentType {
  AI_HEALTH_ANALYSIS
  MEDICAL_DATA_PROCESSING
  HEALTH_DATA_SHARING
  HEALTH_RESEARCH_PARTICIPATION
}

// 用户同意记录模型
model UserConsent {
  id        String      @id @default(cuid())
  userId    String
  consentId String      // 对应同意类型的ID
  granted   Boolean     @default(false)

  // 同意详情
  context   Json?       // 同意时的上下文信息
  ipAddress String?
  userAgent String?

  // 时间管理
  grantedAt DateTime   @default(now())
  expiresAt DateTime?  // 过期时间，null表示永不过期

  // 审计字段
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  @@unique([userId, consentId])
  @@map("user_consents")
  @@index([userId])
  @@index([consentId])
  @@index([granted])
  @@index([expiresAt])
}
